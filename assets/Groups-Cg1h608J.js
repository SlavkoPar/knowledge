import{w as n,x as ys,y as xs,z as fs,E as m,G as me,u as Me,c as re,r as y,H as Ae,J as ye,K as le,L as Ue,M as Rs,N as Fe,O as xe,P as hs,S as Ge,n as e,B as q,o as $e,R as we,D as fe,p as ue,q as As,s as Gs,t as _s,v as Ss}from"./index-B3YM3-wN.js";import{L as ie,F as de,f as We,a as Ve,b as Ke,c as ze,d as Be,e as _e,g as v,S as ve,h as Se,s as Ts,i as Ns,C as He,j as qe,u as je,Q as Xe,k as Oe,l as vs,m as js,B as Qe,n as Os,o as Is,p as bs,M as Re}from"./Options-BVnFDXUx.js";import{A as Ds}from"./AutoSuggestAnswers-DlN7tI9U.js";import"./lib-DMjrWLnO.js";const Te={topId:"",parentId:"null",id:"generateId",groupTitle:"",title:"",source:0,status:0,included:!1},Ie={topId:"null",parentId:"null",id:"define at BackEnd",kind:0,title:"",link:"",header:"",level:0,variations:[],hasSubGroups:!1,groupRows:[],answerRows:[],numOfAnswers:0,hasMoreAnswers:!1,isExpanded:!1,doc1:""},ks=(s,l)=>{console.log("------------------------------->"),console.log("----------------------- GroupReducer >",l.type),console.log("------------------------------->");const{groupRow:u}=l.payload;if(l.type===n.SET_KEY_EXPANDED){const{keyExpanded:w}=l.payload;return{...s,keyExpanded:w,nodeOpened:w===null?!0:s.nodeOpened}}let o=u?!ys.includes(l.type):!1;const{topRows:i}=s,a=xs.includes(l.type)?{...s}:Cs(s,l);if(o&&u){let w;const{topId:x,id:G}=u;if(G===x)w=i.map(A=>A.id===x?new Y(u).groupRow:new Y(A).groupRow);else{const A=i.find(R=>R.id===x);Y.idToSet=l.type==="SET_GROUP_ADDED"?"generateId":G,Y.newGroupRow=u;const r=new Y(A).groupRow;w=i.map(R=>R.id===x?r:new Y(R).groupRow),Y.idToSet=""}a.topRows=w}if(fs.includes(l.type)){const{keyExpanded:w}=a,x={keyExpanded:w};localStorage.setItem("GROUPS_STATE",JSON.stringify(x))}return console.log("GroupReducer newState",a),a},Cs=(s,l)=>{switch(l.type){case n.SET_TOP_ROWS_LOADING:return{...s,loadingGroups:!0,topRowsLoading:!0};case n.SET_TOP_ROWS:{const{topRows:o}=l.payload;return console.log("=> GroupsReducer ActionTypes.SET_TOP_ROWS",o),{...s,topRows:o,topRowsLoading:!1,topRowsLoaded:!0,loadingGroups:!1}}case n.SET_ALL_GROUP_ROWS:{const{allGroupRows:o}=l.payload;return{...s,allGroupRows:o,allGroupRowsLoaded:Date.now()}}case n.SET_NODE_EXPANDING_UP_THE_TREE:{const{groupId_answerId_done:o}=l.payload;return{...s,groupId_answerId_done:o,nodeOpening:!0,loadingGroups:!0,nodeOpened:!1,activeGroup:null,activeAnswer:null}}case n.SET_NODE_EXPANDED_UP_THE_TREE:{const{group:o,formMode:i,grpKey:a,answerId:w,answer:x}=l.payload,{id:G}=a;return{...s,activeGroup:o,activeAnswer:x,selectedAnswerId:w,formMode:i,groupId_answerId_done:`${G}_${w}`,nodeOpening:!1,nodeOpened:!0,loadingGroups:!1}}case n.SET_LOADING_GROUP:return{...s,loadingGroup:!0,groupLoaded:!1};case n.FORCE_GROUP_OPEN_NODE:const{keyExpanded:u}=l.payload;return{...s,topRows:s.topRows.filter(o=>o.parentId===null),keyExpanded:u,nodeOpened:!1,activeGroup:null,activeAnswer:null,selectedAnswerId:null};case n.SET_SUB_GROUPS:return{...s,loadingGroup:!1};case n.SET_GROUP_ERROR:{const{error:o,whichRowId:i}=l.payload;return{...s,error:o,whichRowId:i,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1}}case n.ADD_SUB_GROUP:{const{groupKey:o,level:i}=l.payload,{topId:a}=o,w={...Ie,topId:a,level:i,parentId:""};return{...s,activeGroup:w,formMode:m.AddingGroup}}case n.SET_GROUP:{const{groupRow:o}=l.payload;return console.assert(me(o)),{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:o,activeAnswer:null,selectedAnswerId:null}}case n.SET_ROW_EXPANDING:return{...s,rowExpanding:!0,rowExpanded:!1,loadingGroups:!0};case n.SET_ROW_EXPANDED:{const{groupRow:o}=l.payload,{topId:i,id:a}=o,{keyExpanded:w}=s,x=w?w.answerId:null;return{...s,loadingGroups:!1,keyExpanded:{topId:i,groupId:a,answerId:x},activeAnswer:null,selectedAnswerId:x,loadingAnswer:!1,answerLoaded:!1,rowExpanding:!1,rowExpanded:!0}}case n.SET_ROW_COLLAPSED:{const{groupRow:o}=l.payload,{topId:i,parentId:a}=o;return{...s,loadingGroups:!1,keyExpanded:{topId:i,groupId:a??"",answerId:null},rowExpanding:!1,rowExpanded:!0,activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case n.SET_GROUP_TO_VIEW:{const{groupRow:o}=l.payload;console.assert(me(o));const a={...o,isExpanded:!1};return{...s,formMode:m.ViewingGroup,loadingGroup:!1,activeGroup:a,activeAnswer:null,selectedAnswerId:null}}case n.SET_GROUP_TO_ADD_TOP:{const{newGroupRow:o}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...o,doc1:""},activeAnswer:null,selectedAnswerId:null,topRows:[o,...s.topRows],formMode:m.AddingGroup}}case n.SET_GROUP_TO_ADD:{const{newGroupRow:o}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...o,doc1:""},activeAnswer:null,selectedAnswerId:null,formMode:m.AddingGroup}}case n.SET_GROUP_ADDED:{const{groupRow:o}=l.payload;console.assert(me(o));const a={...o,isExpanded:!1},{topId:w,id:x}=a;return{...s,formMode:m.EditingGroup,loadingGroup:!1,groupLoaded:!1,activeGroup:a,activeAnswer:null,selectedAnswerId:null,keyExpanded:{topId:w,groupId:x,answerId:null}}}case n.SET_GROUP_TO_EDIT:case n.SET_GROUP_UPDATED:{const{groupRow:o,group:i}=l.payload;console.assert(me(o));const{topId:a,id:w}=i;return{...s,formMode:m.EditingGroup,loadingGroup:!1,groupLoaded:!0,keyExpanded:{topId:a,groupId:w,answerId:null},activeGroup:i,activeAnswer:null,selectedAnswerId:null}}case n.SET_ANSWERS_LOADING:return{...s,loadingAnswers:!0,answerLoaded:!1};case n.GROUP_ANSWERS_LOADED:return{...s,loadingAnswers:!1};case n.DELETE_GROUP:return{...s,activeGroup:null,formMode:m.None,error:void 0,whichRowId:void 0};case n.CANCEL_GROUP_FORM:case n.CLOSE_GROUP_FORM:return{...s,activeGroup:null,formMode:m.None};case n.CANCEL_ADD_SUB_GROUP:return{...s,activeGroup:null,activeAnswer:null,selectedAnswerId:null,formMode:m.None};case n.SET_LOADING_ANSWER:return{...s,loadingAnswer:!0,answerLoaded:!1};case n.CANCEL_ADD_ANSWER:return{...s,formMode:m.None,activeAnswer:null,selectedAnswerId:null};case n.SET_ANSWER_SELECTED:{const{answerKey:o}=l.payload,{topId:i,parentId:a,id:w}=o;return{...s,topRows:s.topRows.filter(x=>x.parentId===null),keyExpanded:{topId:i,groupId:a,answerId:w},activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case n.ADD_NEW_ANSWER_TO_ROW:{const{newAnswerRow:o}=l.payload;return{...s,selectedAnswerId:o.id}}case n.SET_ANSWER:{const{answer:o,formMode:i}=l.payload;return console.log(n.SET_ANSWER,o),{...s,activeGroup:null,activeAnswer:o,formMode:i,error:void 0,loadingGroup:!1,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_AFTER_ASSIGN_ANSWER:{const{answer:o}=l.payload;return{...s,activeAnswer:o,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_TO_VIEW:{const{answer:o}=l.payload,{keyExpanded:i}=s;return{...s,formMode:m.ViewingAnswer,keyExpanded:i,activeAnswer:o,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_TO_EDIT:{const{answer:o}=l.payload,{topId:i,id:a,parentId:w}=o;return{...s,keyExpanded:{topId:i,groupId:w,answerId:a},activeAnswer:o,formMode:m.EditingAnswer,selectedAnswerId:o.id,loadingAnswer:!1,answerLoaded:!0}}case n.ANSWER_DELETED:return{...s,activeAnswer:null,selectedAnswerId:null,formMode:m.None,loadingAnswer:!1,answerLoaded:!0};case n.CANCEL_ANSWER_FORM:case n.CLOSE_ANSWER_FORM:return{...s,formMode:m.None,activeAnswer:null,selectedAnswerId:null};case n.SET_ERROR:{const{error:o,whichRowId:i}=l.payload;return{...s,error:o,whichRowId:i,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1}}default:return alert(`Action ${l.type} not allowed`),{...s}}};class Y{static idToSet;static newGroupRow;constructor(l){const{topId:u,id:o,parentId:i,title:a,link:w,kind:x,header:G,level:A,variations:r,numOfAnswers:R,hasSubGroups:D,groupRows:T,created:O,modified:I,answerRows:P,isExpanded:$}=l,_=T.map(j=>(console.log("DeepClone >>>>>>>>>>>>>>>",j.id),j.id===Y.idToSet?{...Y.newGroupRow}:new Y(j).groupRow));this.groupRow={topId:u,parentId:i,id:o,kind:x,title:a,link:w,header:G,level:A,hasSubGroups:D,groupRows:_,numOfAnswers:R,answerRows:P,variations:r??[],created:O,modified:I,isExpanded:$}}groupRow}const Je=y.createContext({}),Ye=y.createContext(()=>null),Ps={formMode:m.None,allGroupRows:new Map,allGroupRowsLoaded:void 0,topRows:[],topRowsLoading:!1,topRowsLoaded:!1,nodeOpening:!1,nodeOpened:!1,keyExpanded:null,groupId_answerId_done:void 0,activeGroup:null,activeAnswer:null,selectedAnswerId:null,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1,error:void 0,rowExpanding:!1,rowExpanded:!1},Ls=({children:s})=>{const{loadAllGroupRowsGlobal:l}=Me(),u=re(),{KnowledgeAPI:o,isAuthenticated:i,workspace:a,authUser:w,canEdit:x}=u,{nickName:G}=w,[A,r]=y.useReducer(ks,Ps),{formMode:R,activeGroup:D,activeAnswer:T,keyExpanded:O,allGroupRows:I,allGroupRowsLoaded:P,topRows:$}=A;console.log("----->>> ----->>> ----->>> GroupProvider",$),y.useEffect(()=>{let d=a==="DEMO"?{topId:"MTS",groupId:"MTS",answerId:"aaaaaa111"}:{topId:"",groupId:"",answerId:""};if("localStorage"in window){let t=localStorage.getItem("GROUPS_STATE");if(console.log("GROUPS_STATE from localStorage",t),t!==null){const g=JSON.parse(t);g.keyExpanded!==null&&(d=g.keyExpanded)}}r({type:n.SET_KEY_EXPANDED,payload:{keyExpanded:d}})},[a]);const _=y.useCallback(async(d,t,g=null,p=void 0)=>{const c=localStorage.getItem("accessToken");if(c)try{console.log("------Execute endpoint:",t);let E=null;const h=new Headers,N=`Bearer ${c}`;h.append("Authorization",N),g&&h.append("Content-Type","application/json");let U={method:d,headers:h,body:g?JSON.stringify(g):null};if(E=await fetch(t,U),E.ok){if(E.status===200||E.status===201){let z=null;try{z=await E.json()}catch{r({type:n.SET_GROUP_ERROR,payload:{error:new Error(`Response status: ${E.status}`),whichRowId:p}})}finally{return z}}}else{const{errors:z}=await E.json(),ee=new Error(z?.map(se=>se.message).join(`
`)??"unknown");r({type:n.SET_GROUP_ERROR,payload:{error:ee,whichRowId:p}})}}catch(E){console.log("-------------->>> execute",d,t,E),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("fetch eror"),whichRowId:p}})}return null},[]),j=y.useCallback(async()=>new Promise(async()=>{const d=await l();r(d?{type:n.SET_ALL_GROUP_ROWS,payload:{allGroupRows:d}}:{type:n.SET_ERROR,payload:{error:new Error("Zajeb allGroupRows")}})}),[l]),F=y.useCallback(async()=>new Promise(async d=>{try{r({type:n.SET_TOP_ROWS_LOADING,payload:{}});const t=`${o.endpointGroupRow}/${a}/toprows`;console.log("GroupProvider loadTopRows url:",t),console.log("loadTopRows AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"),console.time(),await _("GET",t).then(g=>{console.timeEnd(),console.log("loadTopRows GGGGGGGGGGGGGGGGGG");const p=g.map(c=>(c.IsExpanded=O?c.Id===O.groupId:!1,new Ae(c).groupRow));r({type:n.SET_TOP_ROWS,payload:{topRows:p}}),d(!0)})}catch(t){console.log(t),r({type:n.SET_GROUP_ERROR,payload:{error:t}})}}),[_,o.endpointGroupRow,O,a]),S=y.useCallback(async d=>{try{return I.get(d)}catch(t){console.log(t),r({type:n.SET_GROUP_ERROR,payload:{error:t}})}},[I]);y.useEffect(()=>{(async()=>P||await j())()},[P,j]);const M=y.useCallback(async d=>{try{let t="";const g=[];return I.forEach((p,c)=>{c===d?t="":p.parentId===d&&g.push(p)}),{subCats:g,parentHeader:t}}catch(t){return console.log(t),r({type:n.SET_GROUP_ERROR,payload:{error:t}}),{subCats:[],parentHeader:"Kiks subCats"}}},[I]),k=y.useCallback(async(d,t)=>{const{topId:g,id:p}=d;return console.log({groupKey:d,includeAnswerId:t}),new Promise(async c=>{try{const E=`${o.endpointGroup}/${a}/${g}/${p}/${J}/${t}`;console.time(),console.log("================ getGroup ======================="),await _("GET",E).then(h=>{console.timeEnd();const{groupDto:N,msg:U}=h;c(N?new ye(N).group:new Error(U))})}catch(E){console.log(E),c(E)}})},[_,o.endpointGroup,a]),b=y.useCallback(async(d,t)=>{if(d.topId===t)return d;const{groupRows:g}=d;let p=g.find(c=>c.id===t);if(!p)for(const c of g){const E=await b(c,t);if(E){p=E,console.log("finGroup Stop the loop for: "+t);break}}return p},[]),f=y.useCallback(async(d,t,g="false")=>new Promise(async()=>{try{let{topId:p,parentId:c,id:E}=d;if(console.assert(E!==null,"id ne sme biti null u expandNodesUpToTheTree"),E){const z=I.get(E);z?(d.topId=z.topId,d.parentId=z.parentId):alert("reload all groupRow:"+E)}r({type:n.SET_NODE_EXPANDING_UP_THE_TREE,payload:{groupId_answerId_done:`${E}_${t}`}}),console.time();const h={topId:p,id:E,parentId:null},N=new le(h).toQuery(a),U=`${o.endpointGroupRow}?${N}&pageSize=${J}&includeAnswerId=${t??null}`;await _("GET",U).then(async z=>{const{groupRowDto:ee}=z;if(console.timeEnd(),ee){let se=null,pe=null,ae=new Ae(ee).groupRow;if(c!==null){const Ee=await b(ae,E);if(se={...Ee,doc1:""},t){const Pe=Ee.answerRows.find(Le=>Le.id===t&&Le.included);Pe&&(se=null,pe={...Pe,source:0,status:0})}}console.log(">>> expandNodeUpToTheTree groupRow",{groupRow:ae,answerId:"'"+(t??"jok")+"'"+(t??"JOK")});const he=t?x?m.EditingAnswer:m.ViewingAnswer:x?m.EditingGroup:m.ViewingGroup;r({type:n.SET_NODE_EXPANDED_UP_THE_TREE,payload:{grpKey:d,groupRow:ae,group:se,answerId:t??null,answer:pe,formMode:he,fromChatBotDlg:g==="true"}})}})}catch(p){console.log(p),r({type:n.SET_GROUP_ERROR,payload:{error:p}})}}),[a,o.endpointGroupRow,_,I,b,x]),X=y.useCallback(async(d,t=!1,g=null)=>{const p=new le(d).toQuery(a);return new Promise(async c=>{try{const E=`${o.endpointGroupRow}/${t}/${J}/${g}?${p}`;console.time(),await _("GET",E).then(h=>{console.timeEnd();const{groupRowDto:N,msg:U}=h;c(N?new Ae(N).groupRow:new Error(U))})}catch(E){console.log(E),c(E)}})},[_,o.endpointGroupRow,a]),L=y.useCallback(async({groupKey:d,includeAnswerId:t,newAnswerRow:g,formMode:p})=>{try{r({type:n.SET_ROW_EXPANDING,payload:{}});const c=await X(d,!0,t);if(c instanceof Error)r({type:n.SET_GROUP_ERROR,payload:{error:c}}),console.error({cat:c});else{let E;return t&&c.answerRows.filter(h=>h.included).length>0&&(E=t),g&&(c.answerRows=[g,...c.answerRows]),c.isExpanded=!0,console.log("@@@@@@@@@@@@@@@@@ expandGroup:",p,t),p===m.None&&t&&(p=x?m.EditingAnswer:m.ViewingAnswer),r({type:n.SET_ROW_EXPANDED,payload:{groupRow:c,formMode:p,selectedAnswerId:E}}),c}}catch(c){return console.log("error",c),r({type:n.SET_GROUP_ERROR,payload:{error:c}}),null}},[x,X]),C=y.useCallback(async d=>{const{topId:t,id:g}=d,p=$.find(E=>E.id===t),c=await b(p,g);c?(d={...c,isExpanded:!1,groupRows:[],answerRows:[]},r({type:n.SET_ROW_COLLAPSED,payload:{groupRow:d}})):r({type:n.SET_ERROR,payload:{error:new Error("findCategory sranje"),whichRowId:g}})},[b,$]),B=y.useCallback(async d=>{try{r({type:n.CLOSE_GROUP_FORM,payload:{}});const{topId:t,id:g,parentId:p,level:c}=d??{topId:"generateId",id:"generateId",parentId:null,level:0},E={...Ie,topId:t,parentId:d?g:p,id:"generateId",level:c+1,title:"New Group",isExpanded:!1};if(d===null)r({type:n.SET_GROUP_TO_ADD_TOP,payload:{newGroupRow:E}});else{const h={...d,level:c+1,groupRows:[E,...d.groupRows],hasSubGroups:!0,isExpanded:!0};r({type:n.SET_GROUP_TO_ADD,payload:{groupRow:h,newGroupRow:{...E}}})}}catch(t){console.log("error",t),r({type:n.SET_GROUP_ERROR,payload:{error:t}})}},[]),K=y.useCallback(async()=>{try{const{topId:d,id:t,parentId:g}=D,c={groupKey:{topId:d,parentId:g,id:t},formMode:m.None},E=await L(c);E&&r({type:n.CANCEL_ADD_SUB_GROUP,payload:{groupRow:E}})}catch(d){console.log("error",d),r({type:n.SET_GROUP_ERROR,payload:{error:d}})}},[D,L]),ne=y.useCallback(async d=>{const{id:t}=d;r({type:n.SET_LOADING_GROUP,payload:{}});try{const g=new Ue(d,a).groupDto;console.log("groupDto",{groupDto:g});const p=`${o.endpointGroup}`;console.time(),await _("POST",p,g,t).then(async c=>{console.timeEnd();const{groupDto:E}=c;if(E){const h=new ye(E).group;console.log("Group successfully created",{group:h}),I.set(h.id,{...h,isExpanded:!1}),h.parentId===null?r({type:n.SET_GROUP_ADDED,payload:{groupRow:h}}):r({type:n.SET_GROUP_ADDED,payload:{groupRow:h}})}})}catch(g){console.log(g),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:t}})}},[_,o.endpointGroup,j,F,a]),H=y.useCallback(async()=>{try{const{topId:d,parentId:t}=T,p={groupKey:{topId:d,parentId:t,id:t},formMode:m.None},c=await L(p);c&&r({type:n.CANCEL_ADD_ANSWER,payload:{groupRow:c}})}catch(d){console.log("error",d),r({type:n.SET_GROUP_ERROR,payload:{error:d}})}},[T,L]),ce=y.useCallback(async(d,t)=>{R===m.AddingAnswer?await H():R===m.AddingGroup&&await K(),r({type:n.SET_LOADING_GROUP,payload:{groupRow:d}});const g=new le(d).groupKey,p=await k(g,t);p instanceof Error?r({type:n.SET_GROUP_ERROR,payload:{error:p}}):(p.topId=d.topId,r({type:n.SET_GROUP_TO_VIEW,payload:{groupRow:p}}))},[K,H,R,k]),te=y.useCallback(async(d,t)=>{R===m.AddingAnswer?await H():R===m.AddingGroup&&await K(),r({type:n.SET_LOADING_GROUP,payload:{}});const g=new le(d).groupKey,p=await k(g,t);if(p instanceof Error)r({type:n.SET_GROUP_ERROR,payload:{error:p}});else{const c={...p,isExpanded:!1,groupRows:[],answerRows:[]};r({type:n.SET_GROUP_TO_EDIT,payload:{groupRow:c,group:p}})}},[K,H,R,k]),W=y.useCallback(async d=>{r({type:n.SET_LOADING_GROUP,payload:{}});try{const t=new Ue(d,a).groupDto,g=`${o.endpointGroup}`;console.time(),await _("PUT",g,t).then(p=>{console.timeEnd();const{groupDto:c,msg:E}=p;if(c){const h=new ye(c).group,{topId:N}=h;h.isExpanded=!1,h.topId=N,r({type:n.SET_GROUP_UPDATED,payload:{group:h}})}else r({type:n.SET_GROUP_ERROR,payload:{error:new Error(`${E}`)}})})}catch(t){return console.log(t),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Karambol")}}),t}},[_,o.endpointGroup,a]),Z=y.useCallback(async d=>{try{const{topId:t,parentId:g}=d,p=new Rs(d,a).groupRowDto,c=`${o.endpointGroup}`;console.time(),await _("DELETE",c,p).then(async E=>{console.timeEnd();const{groupDto:h,msg:N}=E;N==="OK"?(console.log("Group successfully deleted",{groupRow:d}),await j().then(async()=>{const U={groupKey:{topId:t,parentId:"",id:g},formMode:m.None};g?await F():await L(U).then(()=>{})})):r(N==="HasSubGroups"?{type:n.SET_GROUP_ERROR,payload:{error:new Error("First remove sub groups"),whichRowId:h.Id}}:N==="HasAnswers"?{type:n.SET_GROUP_ERROR,payload:{error:new Error("First remove group answers"),whichRowId:h.Id}}:{type:n.SET_GROUP_ERROR,payload:{error:new Error(N),whichRowId:h.Id}})})}catch(t){return console.log(t),t}},[_,o.endpointGroup,L,j,F,a]),Q=async(d,t)=>{try{console.log("Deleting Group Tag...",{groupKey:d,variationName:t}),console.log("Group Tag successfully deleted")}catch(g){console.log("error",g),r({type:n.SET_GROUP_ERROR,payload:{error:g}})}},J=12,ls=y.useCallback(async({groupKey:d,startCursor:t,includeAnswerId:g})=>{try{const{topId:p,id:c}=d;r({type:n.SET_ANSWERS_LOADING,payload:{}});try{const E=`${o.endpointAnswer}/${a}/${p}/${c}/${t}/${J}/${g}`;console.time(),await _("GET",E).then(h=>{console.timeEnd();const{groupDto:N}=h;if(N!==null){const U=new ye(N).group;r({type:n.GROUP_ANSWERS_LOADED,payload:{groupRow:U}})}})}catch(E){console.log(E),r({type:n.SET_GROUP_ERROR,payload:{error:E}})}}catch(p){console.log(p),r({type:n.SET_GROUP_ERROR,payload:p})}},[_,o.endpointAnswer,a]),ds=y.useCallback(async d=>{try{const{topId:t,id:g}=d;let p=await S(g);if(!p){alert(`Not found ${g}. Reload all Groups`);return}const c={topId:t,parentId:d.id,id:"generateId",title:"answer text",groupTitle:p.title,included:!0},E={...Te,...c,title:""},h=A.topRows.find(U=>U.id===t),N=await b(h,g);r({type:n.ADD_NEW_ANSWER_TO_ROW,payload:{groupRow:{...N,answerRows:[c,...N.answerRows]},newAnswerRow:c}}),r({type:n.SET_ANSWER,payload:{answer:E,formMode:m.AddingAnswer}})}catch(t){console.log("error",t),r({type:n.SET_GROUP_ERROR,payload:{error:t}})}},[L,b,S,A.topRows]),is=y.useCallback(async d=>{const{topId:t,id:g,parentId:p}=d;r({type:n.SET_LOADING_GROUP,payload:{}});try{d.created.nickName=G;const c=new Fe(d,a).answerDto,E=`${o.endpointAnswer}`;console.time(),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> createAnswer",c),await _("POST",E,c).then(async h=>{if(console.timeEnd(),h){console.log("::::::::::::::::::::",{answerDtoEx:h});const{answerDto:N}=h;if(N){const U=new xe(N).answer;U.topId=t,console.log("Answer successfully created"),await j().then(async()=>{const ee={groupKey:{topId:t,parentId:p,id:p},formMode:m.EditingAnswer};await L(ee).then(()=>{r({type:n.SET_ANSWER,payload:{formMode:m.EditingAnswer,answer:U}})})})}}})}catch(c){console.log(c),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[_,o.endpointAnswer,L,j,G,a]),cs=y.useCallback(async(d,t,g)=>{const{id:p}=t;try{t.modified.nickName=G;const c=new Fe(t,a).answerDto,E=`${o.endpointAnswer}`;console.time(),c.oldParentId=d,console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> updateAnswer",c);let h=null;return await _("PUT",E,c).then(async N=>{console.timeEnd();const{answerDto:U,msg:z}=N;if(U){h=new xe(U).answer,console.log("Answer successfully updated: ",h);const{topId:ee,parentId:se}=h;if(g){const{topId:pe,parentId:ae,id:he}=h,Ee={topId:pe,groupId:ae,answerId:he};r({type:n.FORCE_GROUP_OPEN_NODE,payload:{keyExpanded:Ee}})}else{const ae={groupKey:{topId:ee,parentId:se,id:se},formMode:m.EditingAnswer};await L(ae).then(()=>{r({type:n.SET_ANSWER,payload:{formMode:m.EditingAnswer,answer:h}})})}}else r({type:n.SET_GROUP_ERROR,payload:{error:new Error(z)}})}),h}catch(c){console.log(c),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:p}})}},[_,o.endpointAnswer,L,G,a]),ps=y.useCallback(async(d,t)=>{const{id:g,parentId:p,topId:c}=d;r({type:n.SET_LOADING_ANSWER,payload:{}});try{const E=new hs(d,a).answerRowDto,h=`${o.endpointAnswer}`;console.time(),await _("DELETE",h,E).then(async N=>{const{answerDto:U}=N;if(console.timeEnd(),U){const z=new xe(U).answer;console.log("Answer successfully deleted"),t&&r({type:n.ANSWER_DELETED,payload:{answer:z}});const se={groupKey:{topId:c,parentId:p,id:p},formMode:m.None};await L(se).then(()=>{})}else console.error(N),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})})}catch(E){console.log(E),r({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[_,o.endpointAnswer,L,a]),ge=y.useCallback(async d=>new Promise(async t=>{try{const g=new Ge(d).toQuery(a),p=`${o.endpointAnswer}?${g}`;console.time(),console.log("getAnswer",d),await _("GET",p).then(c=>{console.timeEnd();const{answerDto:E,msg:h}=c;if(E){const N={answer:new xe(E).answer,msg:h};t(N)}else t({answer:null,msg:h})})}catch(g){console.log(g),t({answer:null,msg:"Problemos"})}}),[_,o.endpointAnswer,a]),us=y.useCallback(async d=>{const t=new Ge(d).answerKey;r({type:n.SET_LOADING_ANSWER,payload:{}});const g=await ge(t);R===m.AddingAnswer?await H():R===m.AddingGroup&&await K();const{answer:p,msg:c}=g;p?(p.topId=d.topId,r({type:n.SET_ANSWER_TO_VIEW,payload:{answer:p}})):r({type:n.SET_GROUP_ERROR,payload:{error:new Error(c)}})},[K,H,R,ge]),ws=y.useCallback(async d=>{const t=new Ge(d).answerKey;R===m.AddingAnswer?await H():R===m.AddingGroup&&await K(),r({type:n.SET_LOADING_ANSWER,payload:{}}),console.log("editAnswer:",t);const g=await ge(t),{answer:p,msg:c}=g;p?(p.topId=d.topId,r({type:n.CLOSE_ANSWER_FORM,payload:{answer:p}}),r({type:n.SET_ANSWER_TO_EDIT,payload:{answer:p}})):r({type:n.SET_GROUP_ERROR,payload:{error:new Error(c)}})},[K,H,R,ge]),gs=y.useCallback(async(d,t,g)=>{},[b,$]),Es=y.useCallback(async(d,t,g)=>{const{parentId:p,id:c}=t,E=await b(d,p);if(E){const h=E.answerRows.find(N=>N.id===c);h.title=g,console.log("onQuestionTitleChanged+++>>>",c,E),r({type:n.ANSWER_TITLE_CHANGED,payload:{groupRow:E}})}},[b]),ms={state:A,loadAllGroupRows:j,getSubGrps:M,getGrp:S,expandNodesUpToTheTree:f,loadTopRows:F,addSubGroup:B,cancelAddGroup:K,createGroup:ne,viewGroup:ce,editGroup:te,updateGroup:W,deleteGroup:Z,deleteGroupVariation:Q,expandGroup:L,collapseGroup:C,onGroupTitleChanged:gs,loadGroupAnswers:ls,addAnswer:ds,cancelAddAnswer:H,createAnswer:is,viewAnswer:us,editAnswer:ws,updateAnswer:cs,deleteAnswer:ps,onAnswerTitleChanged:Es};return!i||!P||O===null?null:e.jsx(Je.Provider,{value:ms,children:e.jsx(Ye.Provider,{value:r,children:s})})};function V(){return y.useContext(Je)}const be=()=>y.useContext(Ye);var oe=(s=>(s.SET_LOADING="SET_LOADING",s.SET_SUB_CATS="SET_SUB_CATS",s.SET_ERROR="SET_ERROR",s.SET_EXPANDED="SET_EXPANDED",s.SET_PARENT_CAT="SET_PARENT_CAT",s))(oe||{});const Us=({cat:s,dispatch:l,setParentGrp:u,selId:o})=>{const{topId:i,parentId:a,id:w,title:x,level:G,isExpanded:A}=s,r={topId:i,parentId:a,id:w},R=O=>{l({type:oe.SET_EXPANDED,payload:{id:w,expanding:!A}})},D=O=>{u(O)},T=e.jsxs("div",{className:"d-flex justify-content-start align-items-center w-100 text-primary",children:[e.jsx(q,{variant:"link",size:"sm",className:"py-0 px-1",onClick:O=>{R(),O.stopPropagation(),O.preventDefault()},title:"Expand",children:e.jsx(de,{icon:A?We:Ve,size:"lg"})}),e.jsx(q,{variant:"link",size:"sm",className:"py-0 mx-0 text-decoration-none",title:w,onClick:()=>D(s),children:x})]});return e.jsxs(e.Fragment,{children:[e.jsx(ie.Item,{variant:"primary",className:"py-0 px-1 w-100",as:"li",children:T}),A&&e.jsx(ie.Item,{className:"py-0 px-0",variant:"primary",as:"li",children:e.jsx(es,{selId:o,level:G+1,groupKey:r,setParentId:u})})]})},Fs={loading:!1,parentId:null,title:"",cats:[]},Ms=(s,l)=>{switch(l.type){case oe.SET_LOADING:return{...s,loading:!0};case oe.SET_SUB_CATS:{const{subGrps:u}=l.payload;return{...s,cats:s.cats.concat(u),loading:!1}}case oe.SET_ERROR:{const{error:u}=l.payload;return{...s,error:u,loading:!1}}case oe.SET_EXPANDED:{const{id:u,expanding:o}=l.payload;let{cats:i}=s;if(!o){const a=Ze(i,u);console.log("clean:",a),a.length>0&&(i=i.filter(w=>!a.includes(w.id)))}return{...s,cats:s.cats.map(a=>a.id===u?{...a,isExpanded:o}:a)}}case oe.SET_PARENT_CAT:{const{cat:u}=l.payload,{id:o,title:i}=u;return{...s,parentId:o,title:i}}default:return s}};function Ze(s,l){let u=s.filter(o=>o.parentId===l).map(o=>o.id);return u.forEach(o=>{const i=o?Ze(s,o):[];u=u.concat(i)}),u}const es=({selId:s,groupKey:l,level:u,setParentId:o})=>{const[i,a]=y.useReducer(Ms,Fs),{getSubGrps:w}=V(),{id:x}=l??{id:null},[G]=y.useState(l);y.useEffect(()=>{(async()=>{const R=await w(x),{subGrps:D}=R;a({type:oe.SET_SUB_CATS,payload:{subGrps:D}})})()},[w,G,x]);const A=i.cats.filter(R=>R.parentId===x),r=R=>{a({type:oe.SET_PARENT_CAT,payload:{cat:R}}),o(R)};return e.jsxs("div",{className:u>1?"border  border-7 ms-4 h-25":"border border-7  h-25",style:{overflowY:"auto"},children:[e.jsx(ie,{as:"ul",variant:"dark",className:"mb-0",children:A.filter(R=>R.id!==s).map(R=>e.jsx(Us,{cat:R,selId:s,dispatch:a,setParentGrp:r},R.id))}),i.error&&i.error.message]})},De=({answer:s,submitForm:l,children:u,showCloseButton:o,source:i=0,closeModal:a})=>{const{state:w,onAnswerTitleChanged:x}=V();let{formMode:G,topRows:A}=w;const r=G===m.ViewingAnswer,R=G===m.EditingAnswer,D=G===m.AddingAnswer,T=r,{topId:O,id:I,title:P}=s,$=be(),_=()=>{a?a():$({type:n.CLOSE_ANSWER_FORM,payload:{answer:s}})},j=()=>{a?a():$({type:n.CANCEL_ANSWER_FORM,payload:{answer:s}})},[F,S]=y.useState(I+"/"+P),M=Ke(F,500),[k]=y.useState(A.find(C=>C.id===O)),b=y.useRef(null),f=ze({enableReinitialize:!0,initialValues:s,validationSchema:Be().shape({title:_e().required("Required"),parentId:_e().required("Required").notOneOf(["000000000000000000000000"])}),onSubmit:C=>{l(C),S(C.id+"/"+C.title)}});y.useEffect(()=>{(async()=>{const B=M.split("/"),K=B[0];if(f.values.id===K){console.log("AnswerForm.useEffect - onQuestioTitleChanged",{debouncedSearchTerm:M,searchTerm:F,title:f.values.title});const ne=B[1];await x(k,f.values,ne)}})()},[M,f.values,x,F,k]),y.useEffect(()=>{b.current.focus(),i!==0&&f.setFieldValue("source",i)},[f,b,i]);const X=C=>{f.handleChange(C);const B=C.target.value;S(I+"/"+B)},L=C=>{f.setFieldValue("parentId",C.id),f.setFieldValue("groupTitle",C.title)};return console.log("@@@@@@@@@@@@@@@@@@@@@ AnswerForm.render: ",{searchTerm:F,qTitle:P,debouncedSearchTerm:M}),e.jsxs("div",{className:"form-wrapper px-3 py-1 my-0 my-1 w-100 answer-form",children:[o&&e.jsx($e,{onClick:_,className:"float-end"}),e.jsx(we,{className:"text-center",children:e.jsxs(v.Label,{children:["Answer  ",r?"Viewing":R?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:f.handleSubmit,children:[e.jsxs(ve,{direction:"horizontal",gap:0,className:"border",children:[e.jsx("div",{className:"p-0",children:e.jsx(v.Label,{children:"Group:"})}),e.jsx("div",{className:"p-1",children:e.jsxs(v.Group,{controlId:"parentId",className:"group-select form-select-sm w-90",children:[e.jsxs(fe,{children:[e.jsx(fe.Toggle,{variant:"light",id:"dropdown-basic",className:"px-2 py-0 text-primary border",disabled:T,children:e.jsx("span",{className:"text-wrap me-1",children:f.values.groupTitle})}),e.jsx(fe.Menu,{className:"p-0 border",children:e.jsx(fe.Item,{className:"p-0 m-0 rounded-3",children:e.jsx(es,{selId:f.values.parentId,groupKey:null,level:1,setParentId:L})})})]}),e.jsx(v.Control,{as:"input",name:"parentId",onChange:f.handleChange,value:f.values.parentId?f.values.parentId:"",placeholder:"Group",className:"text-primary w-100",disabled:T,hidden:!0}),e.jsx(v.Text,{className:"text-danger",children:f.touched.parentId&&f.errors.parentId?e.jsx("div",{className:"text-danger",children:f.errors.parentId?"required":""}):null})]})})]}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:f.values.title==="new Answer"?"new Answer":"answer text",ref:b,onChange:X,value:f.values.title,rows:3,className:"text-primary w-100",disabled:T}),e.jsx(v.Text,{className:"text-danger",children:f.touched.title&&f.errors.title?e.jsx("div",{className:"text-danger",children:f.errors.title}):null})]}),e.jsxs(we,{children:[e.jsx(ue,{children:e.jsxs(v.Group,{controlId:"source",children:[e.jsx(v.Label,{children:"Source"}),e.jsx(Se,{id:"source",name:"source",options:Ts,onChange:(C,B)=>{C.preventDefault(),f.setFieldValue("source",B)},value:f.values.source,disabled:T,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:f.touched.source&&f.errors.source?e.jsx("div",{className:"text-danger",children:f.errors.source}):null})]})}),e.jsx(ue,{children:e.jsxs(v.Group,{controlId:"status",children:[e.jsx(v.Label,{children:"Status"}),e.jsx(Se,{id:"status",name:"status",options:Ns,onChange:(C,B)=>{C.preventDefault(),f.setFieldValue("status",B)},value:f.values.status,disabled:T,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:f.touched.status&&f.errors.status?e.jsx("div",{className:"text-danger",children:f.errors.status}):null})]})})]}),(r||R)&&e.jsx("div",{className:"my-1",children:e.jsx(He,{created:s.created,modified:s.modified,classes:"text-primary"})}),(f.dirty&&R||D)&&e.jsx(qe,{cancelForm:j,handleSubmit:f.handleSubmit,title:u}),w.error&&e.jsx("div",{className:"text-danger",children:w.error.message})]})]})},ke=({closeModal:s,showCloseButton:l,source:u,setError:o})=>{const{state:i,cancelAddAnswer:a,createAnswer:w}=V(),{activeAnswer:x}=i,G=x?x.topId:"",A=async()=>{await a()},r=async R=>{const D={...R,topId:G,created:{time:new Date,nickName:""},modified:void 0},T=await w(D,s!==void 0);T&&(T.message?o(T.message):s&&s())};return x?e.jsx(De,{answer:x,showCloseButton:l??!0,source:u??0,closeModal:A,submitForm:r,children:"Create Answer"}):null},ss=({})=>{const{state:s,updateAnswer:l}=V(),{activeAnswer:u}=s;if(!u)return null;if(!u)return e.jsx("div",{children:"Loading answer to edit..."});const o=async i=>{const a={...i,created:void 0,modified:{time:new Date,nickName:""}},{parentId:w}=u,x=w!==a.parentId;await l(w,a,x)};return e.jsx(De,{answer:u,showCloseButton:!0,source:0,submitForm:o,children:"Update Answer"})},os=({inLine:s})=>{console.log(s?"ViewAnswer inLine":"ViewAnswer not inLine");const{state:l}=V(),{activeAnswer:u}=l,[o,i]=y.useState(null);return y.useEffect(()=>{console.log("#################################### ViewAnswer setAnswer ...",{activeAnswer:u}),i(u)},[u]),e.jsx(De,{answer:o,showCloseButton:!0,source:0,submitForm:()=>{},children:"View Answer"})},$s=({answerRow:s,isSelected:l})=>{const{id:u,topId:o,parentId:i,title:a}=s,w={topId:o,parentId:i,id:i},{canEdit:x,authUser:G}=re(),{state:A,viewAnswer:r,addAnswer:R,editAnswer:D,deleteAnswer:T}=V(),{activeAnswer:O,formMode:I,loadingAnswer:P,answerLoaded:$}=A,_=O!==null&&O.id===u,j=I===m.AddingAnswer,F=()=>{s.modified={time:new Date,nickName:G.nickName},T(s,_)},S=async f=>{console.log("AnswerRow onSelectAnswer",{id:f}),x?await D(s):await r(s)},[M,k]=je();y.useEffect(()=>{(async()=>{if(l&&!P&&!$){switch(I){case m.ViewingAnswer:await r(s);break;case m.EditingAnswer:console.log("Zovem from AnswerRow"),x?await D(s):await r(s);break}document.getElementById(`AnswerRow${u}`)?.scrollIntoView({behavior:"smooth",block:"end"})}})()},[x,D,I,u,l,P,$,s,r]);const b=e.jsxs("div",{id:`AnswerRow${u}`,className:`d-relative d-flex justify-content-start align-items-center w-100 answer-row${l?"-selected":""}`,style:{marginTop:"0px"},children:[e.jsx(q,{variant:"link",size:"sm",className:"d-flex align-items-center px-1 text-secondary",children:e.jsx("img",{width:"22",height:"18",src:As,alt:"Answer"})}),e.jsx(q,{variant:"link",size:"sm",className:`p-0 px-1 m-0 ms-0 answer-row-title ${_?"fw-bold":""}`,title:`id:${u.toString()}`,onClick:()=>S(u),disabled:j,children:a}),x&&!j&&k&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx(q,{variant:"link",size:"sm",className:"ms-1 p-0 text-secondary d-flex align-items-center",title:"Add Answer",onClick:()=>{R(w,!0)},children:e.jsx("img",{width:"22",height:"18",src:Xe,alt:"Add Answer"})}),e.jsx(q,{variant:"link",size:"sm",className:"ms-0 p-0 text-secondary",onClick:F,children:e.jsx(de,{icon:Oe,size:"lg"})})]})]});return e.jsxs(ie.Item,{className:"py-0 px-0 w-100",as:"li",children:[l&&I===m.AddingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(ke,{showCloseButton:!0,source:0})}),e.jsx("div",{ref:M,className:"d-none d-md-block  border rounded-3",children:b})]}),l&&I===m.EditingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:M,className:"",children:b}),e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(ss,{inLine:!0})})]}),l&&I===m.ViewingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:M,className:"",children:b}),e.jsx("div",{ref:M,id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(os,{inLine:!0})})]}),!l&&e.jsx("div",{ref:M,className:"",children:b})]})},ns=({groupRow:s})=>{const{state:l,loadGroupAnswers:u}=V(),{keyExpanded:o,loadingAnswer:i,error:a,selectedAnswerId:w}=l,{answerId:x}=o;s.level+=1;const{answerRows:G}=s;let A=!1;async function r(){try{const T={groupKey:new le(s).groupKey,startCursor:G.length,includeAnswerId:x??null};console.log("^^^^^^^^^^^^^ loadMore"),console.log("^^^^^^^^^^^^^",{x:T}),console.log("^^^^^^^^^^^^^ loadMore"),await u(T)}catch{}}const[R,{rootRef:D}]=vs({loading:i,hasNextPage:A,onLoadMore:r,disabled:!!a,rootMargin:"0px 0px 100px 0px"});return e.jsxs("div",{ref:D,className:"ms-0",style:{maxHeight:"400px",overflowY:"auto"},children:[e.jsxs(js,{children:[G.length===0&&e.jsx("label",{children:"No answers"}),G.map(T=>e.jsx($s,{answerRow:T,isSelected:T.id===w},T.id)),A]}),a&&e.jsxs("p",{children:["Error: ",a.message]})]})},Ws=({groupKey:s,tag:l,groupInAdding:u})=>{const{name:o}=l,{canEdit:i}=re(),{state:a,deleteGroupVariation:w}=V(),x=()=>{w(s,o)},[G,A]=je(),r=e.jsxs("div",{ref:G,children:[e.jsx(Qe,{pill:!0,bg:"secondary",children:o}),i&&!0&&A&&e.jsx(q,{variant:"link",size:"sm",className:"ms-0 py-0 mx-0 text-secondary",onClick:x,children:e.jsx(de,{icon:Oe,size:"sm"})}),!1]});return e.jsx("div",{className:"py-1 px-1",children:r})},Vs=({groupKey:s,variations:l})=>{const{state:u}=V(),{error:o}=u;return y.useEffect(()=>{},[]),e.jsxs("div",{className:"ms-2",children:[e.jsxs(ve,{direction:"horizontal",gap:2,children:[l.length===0&&e.jsx("div",{children:"No variations"}),l.length>0&&l.map(i=>e.jsx(Ws,{groupKey:s,tag:i,groupInAdding:void 0}))]}),o&&e.jsxs("p",{children:["Error: ",o.message]})]})},Ce=({formMode:s,group:l,submitForm:u,children:o})=>{const{onGroupTitleChanged:i}=V(),a=s===m.ViewingGroup,w=s===m.EditingGroup,x=s===m.AddingGroup,{topId:G,id:A,variations:r,answerRows:R,title:D}=l;console.log("GroupForm render: ",{topId:G,id:A,catTitle:D,formMode:s});const T=new le(l).groupKey;document.getElementById("div-details");const O=R&&R.length>0,I=be(),P=()=>{I({type:n.CLOSE_GROUP_FORM,payload:{}})},$=()=>{I({type:n.CANCEL_GROUP_FORM,payload:{}})},[_,j]=y.useState(D),F=Ke(_,300),S=ze({enableReinitialize:!0,initialValues:l,validationSchema:Be().shape({title:_e().required("Required")}),onSubmit:f=>{console.log("GroupForm.onSubmit",JSON.stringify(f,null,2)),u(f),j(f.title)}});y.useEffect(()=>{(async()=>(console.log("GroupForm.useEffect - onGroupTitleChanged",{debouncedSearchTerm:F,title:S.values.title}),i(G,A,S.values.title)))()},[F,S.values.title,i]);const M=f=>{S.handleChange(f);const X=f.target.value;j(X)},k=y.useRef(null);y.useEffect(()=>{k.current?.focus()},[k]);const b=!1;return console.log("GroupForm render return: ",_),e.jsxs("div",{className:"form-wrapper p-2 group-form",children:[e.jsx($e,{onClick:P,className:"float-end"}),e.jsx(we,{className:"text-center text-muted",children:e.jsxs(v.Label,{children:["Group ",a?"Viewing":w?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:()=>S.handleSubmit,children:[e.jsx(v.Group,{controlId:"Variations",children:e.jsxs(ve,{direction:"horizontal",gap:1,children:[e.jsx("div",{className:"px-0",children:e.jsx(v.Label,{children:"Variations:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsx(Vs,{groupKey:T,variations:r?r.map(f=>({name:f})):[]})}),e.jsx("div",{className:"ps-2",children:e.jsx(v.Label,{children:"Kind:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsxs(v.Group,{controlId:"kind",children:[e.jsx(Se,{id:"kind",name:"kind",options:Os,onChange:(f,X)=>{f.preventDefault(),S.setFieldValue("kind",X)},value:S.values.kind,disabled:b,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:S.touched.kind&&S.errors.kind?e.jsx("div",{className:"text-danger",children:S.errors.kind}):null})]})})]})}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:"new Group",value:_,onFocus:f=>{s===m.AddingGroup&&f.target.select()},onChange:M,ref:k,rows:3,className:"text-primary w-100",disabled:a}),e.jsx(v.Text,{className:"text-danger",children:S.touched.title&&S.errors.title?e.jsx("div",{className:"text-danger",children:S.errors.title}):null})]}),e.jsxs(v.Group,{controlId:"link",children:[e.jsx(v.Label,{children:"Link"}),S.values.hasSubGroups?e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:"Can't have link (has sub groups)",disabled:!0}):e.jsxs(e.Fragment,{children:[e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:S.values.link??"",disabled:a}),e.jsx(v.Text,{className:"text-danger",children:S.touched.link&&S.errors.link?e.jsx("div",{className:"text-danger",children:S.errors.link}):null})]})]}),e.jsxs(v.Group,{children:[e.jsxs(v.Label,{className:"m-1 mb-0",children:["Answers (",`${S.values.numOfAnswers}`,") "]}),O&&e.jsx(ns,{groupRow:l})]}),(a||w)&&e.jsx(He,{created:l.created,modified:l.modified,classes:"text-primary"}),(S.dirty&&w||x)&&e.jsx(qe,{cancelForm:$,handleSubmit:S.handleSubmit,title:o})]})]})},rs=({inLine:s})=>{const l=re(),{nickName:u}=l.authUser,{state:o,updateGroup:i}=V(),{activeGroup:a,keyExpanded:w}=o,{answerId:x}=w,G=async A=>{const r={...A,created:void 0,modified:{time:new Date,nickName:u}};await i(r,!0)};return e.jsx(Ce,{inLine:s,group:{...a},answerId:x,formMode:m.EditingGroup,submitForm:G,children:"Update Group"})},Ne=({inLine:s})=>{const{state:l}=V(),{activeGroup:u,keyExpanded:o}=l,{answerId:i}=o;return e.jsx(Ce,{inLine:s,group:{...u},answerId:i,formMode:m.ViewingGroup,submitForm:()=>{},children:"View Group"})},ts=({activeGroup:s})=>{const l=re(),{nickName:u}=l.authUser,{createGroup:o}=V(),[i]=y.useState({...s}),a=async w=>{const x={...w,created:{time:new Date,nickName:u},modified:void 0};console.log("**********object",x),await o(x)};return!s===null?null:(console.log("AddGroup render >>>>>:",s),e.jsx(e.Fragment,{children:e.jsx(Ce,{inLine:!1,group:i,answerId:null,formMode:m.AddingGroup,submitForm:a,children:"Create Group"})}))},Ks=({groupRow:s,answerId:l})=>{const{id:u,title:o,hasSubGroups:i,numOfAnswers:a,isExpanded:w,groupRows:x}=s;s.level+=1;const G=new le(s).groupKey,{canEdit:A,authUser:r}=re(),{state:R,addSubGroup:D,viewGroup:T,editGroup:O,deleteGroup:I,expandGroup:P,collapseGroup:$,addAnswer:_}=V();let{formMode:j,activeGroup:F,loadingGroup:S,groupLoaded:M}=R;const k=F!==null&&F.id===u,b=j===m.AddingGroup,f=w&&a>0,X=()=>{s.modified={time:new Date,nickName:r.nickName},I(s)},L=async()=>{w?await $(s):await P({groupKey:G})},[C,B]=y.useState(!1);y.useEffect(()=>{B(!0)},[x]);const K=async()=>{A?await O(s,l??"null"):await T(s,l??"null")},[ne,H]=y.useState(!1);y.useEffect(()=>{ne&&(D(s),H(!1))},[D,s,ne]);const[ce,te]=y.useState(!1);y.useEffect(()=>{ce&&(_(G,w??!1),te(!1))},[_,G,w,ce]),y.useEffect(()=>{(async()=>{if(k&&!S&&!M&&!b)switch(console.log("GroupRow formMode:",j),j){case m.ViewingGroup:await T(s,l??"null");break;case m.EditingGroup:A?await O(s,l??"null"):await T(s,l??"null");break}})()},[A,G,M,s,O,P,j,b,k,S,l,T]);const[W,Z]=je(),Q=e.jsxs("div",{children:[e.jsxs("div",{id:`Row${u}`,className:`d-relative d-flex justify-content-start align-items-center w-100 mt-1 group-row${k?"-selected":""}`,style:{marginTop:"1px"},children:[e.jsx(q,{variant:"link",size:"sm",className:"py-0 px-1","aria-controls":u+"-2","aria-expanded":C,onClick:J=>{L(),J.stopPropagation()},title:"Expand",disabled:b||!i&&a===0,children:e.jsx(de,{icon:w?We:Ve,size:"lg"})}),e.jsx(q,{variant:"link",size:"sm",className:"py-0 px-1 bg-light",title:"Expand",disabled:!0,children:e.jsx(de,{icon:Is,size:"sm"})}),e.jsx(q,{variant:"link",size:"sm",className:`py-0 ms-0 me-1 group-row-title ${k?"fw-bold text-white bg-transparent":""}`,title:u,onClick:K,disabled:b,children:o}),a>0&&e.jsxs(Qe,{pill:!0,bg:"secondary",className:"d-inline bg-transparent",children:[a,"Q"]}),A&&Z&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx("div",{className:"d-flex align-items-center",children:e.jsx(q,{variant:"link",size:"sm",className:"border-0 py-0 px-0 ms-0 text-success",title:"Add SubGroup",onClick:async()=>{!w&&(i||a>0)&&await L(),setTimeout(()=>H(!0),1e3)},children:e.jsx(de,{icon:bs,size:"lg"})})}),!b&&!i&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(q,{variant:"link",size:"sm",className:"p-0 mx-0 text-secondary d-flex align-items-center border border-0 border-warning1",title:"Add Answer",onClick:async()=>{!w&&(i||a>0)&&await L(),setTimeout(()=>te(!0),500)},children:e.jsx("img",{width:"22",height:"18",src:Xe,alt:"Add Answer"})}),e.jsx(q,{variant:"link",size:"sm",className:"d-flex align-items-center border border-0 border-warning p-0",disabled:i||a>0,onClick:X,children:e.jsx(de,{icon:Oe,size:"lg"})})]})]})]}),f&&e.jsx("div",{className:"ps-3",children:e.jsx(ns,{groupRow:s})})]});return e.jsxs(e.Fragment,{children:[e.jsxs(ie.Item,{className:"py-0 px-1 w-100 group-bg",as:"li",children:[k&&j===m.AddingGroup&&e.jsxs("div",{children:[e.jsx("div",{ref:W,className:"",children:Q}),e.jsx("div",{className:"ms-0 d-md-none w-100",children:e.jsx(ts,{activeGroup:F})})]}),k&&j===m.EditingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:W,children:Q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(rs,{inLine:!1})})]}),k&&j===m.ViewingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:W,children:Q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(Ne,{inLine:!1})})]}),k&&j===m.None&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:W,children:Q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(Ne,{inLine:!1})})]}),!k&&e.jsx("div",{ref:W,children:Q})]}),R.error&&R.whichRowId===u&&e.jsx("div",{className:"text-danger",children:R.error.message}),w&&e.jsx(ie.Item,{className:"py-0 px-0 border-0 border-warning border-bottom-0 group-bg p-0 m-0",variant:"primary",as:"li",children:e.jsx("div",{className:"rambo",children:i&&e.jsx(Gs,{in:C,children:e.jsx("div",{id:u+"-2",style:{marginTop:"1px"},children:e.jsx("div",{style:{border:"1px solid #ddd",borderRadius:"4px"},children:e.jsx(as,{groupRow:s,isExpanded:w})})})})})})]})},as=({groupRow:s})=>{const{level:l,groupRows:u}=s,{state:o}=V();let{keyExpanded:i}=o;const{answerId:a}=i??{answerId:null};return e.jsx("div",{className:l>1?"ms-2":"",children:e.jsx(ie,{as:"ul",variant:"dark",className:"mb-0 group-bg",children:u.map(w=>e.jsx(Ks,{groupRow:w,answerId:a===""?null:a},w.id))})})},zs=s=>{const{isDarkMode:l}=re(),[u,o]=y.useState("");return y.useEffect(()=>{},[]),e.jsxs(Re,{show:s.show,onHide:s.onHide,animation:!0,centered:!0,size:"lg",className:"modal show",contentClassName:`${l?"bg-secondary bg-gradient":"bg-info bg-gradient"}`,children:[e.jsx(Re.Header,{closeButton:!0,children:"Store new Answer to the Database"}),e.jsx(Re.Body,{className:"py-0",children:e.jsx(ke,{closeModal:s.onHide,showCloseButton:!1,source:1,setError:i=>o(i)})}),e.jsx(Re.Footer,{children:u})]})},Bs=({groupId_answerId:s,fromChatBotDlg:l})=>{const{state:u,expandNodesUpToTheTree:o,loadTopRows:i,addSubGroup:a}=V(),{allGroupRows:w,topRows:x,topRowsLoading:G,topRowsLoaded:A,keyExpanded:r,groupId_answerId_done:R,nodeOpening:D,nodeOpened:T,activeGroup:O,activeAnswer:I,formMode:P,loadingGroups:$,loadingGroup:_,loadingAnswers:j,loadingAnswer:F}=u,{searchAnswers:S,setLastRouteVisited:M,setChatBotDlgEnabled:k}=Me(),{isDarkMode:b,chatBotDlgEnabled:f,lastRouteVisited:X}=re(),[L,C]=y.useState(!1),[B,K]=y.useState({...Te}),ne=be(),H=async W=>{ne({type:n.SET_ANSWER_SELECTED,payload:{answerKey:W}})};let ce="";y.useEffect(()=>{(async()=>!G&&!A&&(console.log("ZOVEM 111 loadTopRows()"),await i()))()},[G,A,i]),y.useEffect(()=>{(async()=>{if(!D&&A&&x.length>0){if(s){if(s==="add_answer"){const W=localStorage.getItem("New_Answer");if(W){const Z=JSON.parse(W);return K({...Te,groupTitle:"Select",...Z}),C(!0),localStorage.removeItem("New_Answer"),null}}else if(s!==R){const W=s.split("_"),Z=W[0],Q=W[1],J={topId:"",id:Z,parentId:"ROOT"};console.log("zovem expandNodesUpToTheTree 1111111111111111111)",{groupId_answerId:s},{groupId_answerId_done:R}),await o(J,Q!=="null"?Q:null),console.log("zavrsio expandNodeUpToTheTree 1111111111111111111 DONE)",{groupId_answerId:s})}}else if(r&&!T){const{topId:W,groupId:Z,answerId:Q}=r;if(Z!==""){const J={topId:W,id:Z,parentId:"ROOT"};console.log("zovem expandNodeUpToTheTree 2222222222222)",{keyExpanded:r,catKey:J}),await o(J,Q),console.log("zavrsio expandNodeUpToTheTree 2222222222222 DONE)")}}f||k()}})()},[s,R,A,r,D,T,o,l,f,k]);const te="/knowledge/groups";return y.useEffect(()=>{X!==te&&M(te)},[X,M]),s!=="add_answer"&&s&&s!==R?(console.log("zzzzzz loading...",{keyExpanded:r,groupId_answerId:s,groupId_answerId_done:R}),e.jsx("div",{children:"loading..."})):A?(console.log("===>>> Groups !!!!!!!!!!!!!!!!!",O),e.jsxs(e.Fragment,{children:[e.jsxs(Ss,{children:[e.jsxs("h5",{className:"text-warning mx-auto w-75 fw-bold",children:[e.jsx("span",{className:"groups",children:"Groups / "}),e.jsx("span",{className:"answers",children:"Answers"})]}),e.jsx(we,{className:`${b?"dark":""}`,children:e.jsx(ue,{children:e.jsx("div",{className:"d-flex justify-content-start align-items-center",children:e.jsx("div",{className:"w-75 my-1 answers",children:e.jsx(Ds,{tekst:ce,onSelectAnswer:H,allGroupRows:w,searchAnswers:S})})})})}),e.jsx(q,{variant:"secondary",size:"sm",type:"button",style:{padding:"1px 4px"},onClick:()=>a(null),children:"Add Group"}),e.jsxs(we,{className:"my-1 h-auto",children:[e.jsx(ue,{xs:12,md:5,children:e.jsx("div",{className:"groups-border",style:{position:"relative"},children:e.jsx(as,{groupRow:{...Ie,groupRows:x},isExpanded:!0})})}),e.jsx(ue,{xs:0,md:7,children:e.jsxs("div",{id:"div-details",className:"d-none d-md-block",children:[O&&P===m.ViewingGroup&&e.jsx(Ne,{inLine:!1}),O&&P===m.EditingGroup&&e.jsx(rs,{inLine:!1}),O&&P===m.AddingGroup&&e.jsx(ts,{activeGroup:O}),I&&P===m.ViewingAnswer&&e.jsx(os,{inLine:!1}),I&&P===m.EditingAnswer&&e.jsx(ss,{inLine:!1}),I&&P===m.AddingAnswer&&e.jsx(ke,{})]})})]})]}),L&&I&&e.jsx(zs,{show:L,onHide:()=>{C(!1)},newAnswerRow:B}),($||j)&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"40%",left:"20%"},children:e.jsx("div",{className:`spinner-border ${j?"answer":"group"}-spinner`,role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),_&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border group-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),F&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border answer-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})]})):(console.log("===>>> Groups  VRATIO"),null)},Js=()=>{let{groupId_answerId:s,fromChatBotDlg:l}=_s();if(s&&s==="groups"&&(s=void 0),s){const u=s.split("_");console.assert(u.length===2,"expected 'groupId_answerId'")}return e.jsx(Ls,{children:e.jsx(Bs,{groupId_answerId:s,fromChatBotDlg:l})})};export{Js as default};
//# sourceMappingURL=Groups-Cg1h608J.js.map
