import{w as o,x as Es,y as ys,z as xs,E,G as ge,u as Pe,c as se,r as x,H as Re,J as me,K as re,L as ke,M as fs,N as Ce,O as Ee,P as Rs,S as he,n as e,B as X,o as Le,R as ce,D as ye,p as ie,q as hs,t as As,v as Gs}from"./index-l_47E4Ly.js";import{L as ae,F as te,f as Ue,a as Me,b as Fe,c as Be,d as $e,e as Ae,g as v,S as Se,h as Ge,s as _s,i as Ss,C as We,j as Ve,u as Te,Q as Ts,k as Ne,l as Ns,m as vs,B as Ke,n as Os,o as js,p as Is,M as xe}from"./Options-BDyjfI1g.js";import{A as bs}from"./AutoSuggestAnswers-BRQfGxAF.js";import"./lib-DeElOo52.js";const _e={topId:"",parentId:"null",id:"generateId",groupTitle:"",title:"",source:0,status:0,included:!1},ze={topId:"null",parentId:"null",id:"define at BackEnd",kind:0,title:"",link:"",header:"",level:0,variations:[],hasSubGroups:!1,groupRows:[],answerRows:[],numOfAnswers:0,hasMoreAnswers:!1,isExpanded:!1,doc1:""},Ds=(s,l)=>{console.log("------------------------------->"),console.log("----------------------- GroupReducer >",l.type),console.log("------------------------------->");const{groupRow:u}=l.payload;if(l.type===o.SET_FROM_LOCAL_STORAGE){const{keyExpanded:w}=l.payload;return{...s,keyExpanded:w}}let n=u?!Es.includes(l.type):!1;const{topRows:i}=s,a=ys.includes(l.type)?{...s}:ks(s,l);if(n&&u){let w;const{topId:y,id:G}=u;if(G===y)w=i.map(_=>_.id===y?new J(u).groupRow:new J(_).groupRow);else{const _=i.find(R=>R.id===y);J.idToSet=G,J.newGroupRow=u;const r=new J(_).groupRow;w=i.map(R=>R.id===y?r:new J(R).groupRow),J.idToSet=""}a.topRows=w}if(xs.includes(l.type)){const{keyExpanded:w}=a,y={keyExpanded:w};localStorage.setItem("GROUPS_STATE",JSON.stringify(y))}return console.log("GroupReducer newState",a),a},ks=(s,l)=>{switch(l.type){case o.SET_TOP_ROWS_LOADING:return{...s,loadingGroups:!0,topRowsLoading:!0};case o.SET_TOP_ROWS:{const{topRows:n}=l.payload;return console.log("=> GroupsReducer ActionTypes.SET_TOP_ROWS",s.topRows,n),{...s,topRows:n,topRowsLoading:!1,topRowsLoaded:!0,loadingGroups:!1}}case o.SET_ALL_GROUP_ROWS:{const{allGroupRows:n}=l.payload;return{...s,allGroupRows:n,allGroupRowsLoaded:Date.now()}}case o.SET_NODE_EXPANDING_UP_THE_TREE:{const{keyExpanded:n,activeGroup:i,activeAnswer:a}=s;return{...s,nodeOpening:!0,loadingGroups:!0,nodeOpened:!1,keyExpanded:{...n},activeGroup:i,activeAnswer:a}}case o.SET_NODE_EXPANDED_UP_THE_TREE:{const{group:n,formMode:i,grpKey:a,answerId:w,answer:y}=l.payload,{id:G}=a;return{...s,activeGroup:n,activeAnswer:y,selectedAnswerId:w,formMode:i,groupId_answerId_done:`${G}_${w}`,nodeOpening:!1,nodeOpened:!0,loadingGroups:!1}}case o.SET_LOADING_GROUP:return{...s,loadingGroup:!0,groupLoaded:!1};case o.FORCE_GROUP_OPEN_NODE:const{keyExpanded:u}=l.payload;return{...s,topRows:s.topRows.filter(n=>n.parentId===null),keyExpanded:u,nodeOpened:!1,activeGroup:null,activeAnswer:null,selectedAnswerId:null};case o.SET_SUB_GROUPS:return{...s,loadingGroup:!1};case o.SET_GROUP_ERROR:{const{error:n,whichRowId:i}=l.payload;return{...s,error:n,whichRowId:i,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1}}case o.ADD_SUB_GROUP:{const{groupKey:n,level:i}=l.payload,{topId:a}=n,w={...ze,topId:a,level:i,parentId:""};return{...s,activeGroup:w,formMode:E.AddingGroup}}case o.SET_GROUP:{const{groupRow:n}=l.payload;return console.assert(ge(n)),{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:n,activeAnswer:null,selectedAnswerId:null}}case o.SET_ROW_EXPANDING:return{...s,rowExpanding:!0,rowExpanded:!1,loadingGroups:!0};case o.SET_ROW_EXPANDED:{const{groupRow:n}=l.payload,{topId:i,id:a}=n,{keyExpanded:w}=s,y=w?w.answerId:null;return{...s,loadingGroups:!1,keyExpanded:{topId:i,groupId:a,answerId:y},activeAnswer:null,selectedAnswerId:y,loadingAnswer:!1,answerLoaded:!1,rowExpanding:!1,rowExpanded:!0}}case o.SET_ROW_COLLAPSED:{const{groupRow:n}=l.payload,{topId:i,parentId:a}=n;return{...s,loadingGroups:!1,keyExpanded:{topId:i,groupId:a??"",answerId:null},rowExpanding:!1,rowExpanded:!0,activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case o.SET_GROUP_TO_VIEW:{const{groupRow:n}=l.payload;console.assert(ge(n));const a={...n,isExpanded:!1};return{...s,formMode:E.ViewingGroup,loadingGroup:!1,activeGroup:a,activeAnswer:null,selectedAnswerId:null}}case o.SET_GROUP_TO_ADD_TOP:{const{newGroupRow:n}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...n,doc1:""},activeAnswer:null,selectedAnswerId:null,topRows:[n,...s.topRows],formMode:E.AddingGroup}}case o.SET_GROUP_TO_ADD:{const{newGroupRow:n}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...n,doc1:""},activeAnswer:null,selectedAnswerId:null,formMode:E.AddingGroup}}case o.SET_GROUP_ADDED:{const{groupRow:n}=l.payload;console.assert(ge(n));const a={...n,isExpanded:!1},{topId:w,id:y}=a;return{...s,formMode:E.EditingGroup,loadingGroup:!1,groupLoaded:!1,activeGroup:a,activeAnswer:null,selectedAnswerId:null,keyExpanded:{topId:w,groupId:y,answerId:null},nodeOpened:!1}}case o.SET_GROUP_TO_EDIT:case o.SET_GROUP_UPDATED:{const{groupRow:n,group:i}=l.payload;console.assert(ge(n));const{topId:a,id:w}=i;return{...s,formMode:E.EditingGroup,loadingGroup:!1,groupLoaded:!0,keyExpanded:{topId:a,groupId:w,answerId:null},activeGroup:i,activeAnswer:null,selectedAnswerId:null}}case o.SET_ANSWERS_LOADING:return{...s,loadingAnswers:!0,answerLoaded:!1};case o.GROUP_ANSWERS_LOADED:return{...s,loadingAnswers:!1};case o.DELETE_GROUP:return{...s,activeGroup:null,formMode:E.None,error:void 0,whichRowId:void 0};case o.CANCEL_GROUP_FORM:case o.CLOSE_GROUP_FORM:return{...s,activeGroup:null,formMode:E.None};case o.CANCEL_ADD_SUB_GROUP:return{...s,activeGroup:null,activeAnswer:null,selectedAnswerId:null,formMode:E.None};case o.SET_LOADING_ANSWER:return{...s,loadingAnswer:!0,answerLoaded:!1};case o.CANCEL_ADD_ANSWER:return{...s,formMode:E.None,activeAnswer:null,selectedAnswerId:null};case o.SET_ANSWER_SELECTED:{const{answerKey:n}=l.payload,{topId:i,parentId:a,id:w}=n;return{...s,topRows:s.topRows.filter(y=>y.parentId===null),keyExpanded:{topId:i,groupId:a,answerId:w},nodeOpened:!1,activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case o.ADD_NEW_ANSWER_TO_ROW:{const{newAnswerRow:n}=l.payload;return{...s,selectedAnswerId:n.id}}case o.SET_ANSWER:{const{answer:n,formMode:i}=l.payload;return console.log(o.SET_ANSWER,n),{...s,activeGroup:null,activeAnswer:n,formMode:i,error:void 0,loadingGroup:!1,loadingAnswer:!1,answerLoaded:!0}}case o.SET_ANSWER_AFTER_ASSIGN_ANSWER:{const{answer:n}=l.payload;return{...s,activeAnswer:n,loadingAnswer:!1,answerLoaded:!0}}case o.SET_ANSWER_TO_VIEW:{const{answer:n}=l.payload,{keyExpanded:i}=s;return{...s,formMode:E.ViewingAnswer,keyExpanded:i,activeAnswer:n,loadingAnswer:!1,answerLoaded:!0}}case o.SET_ANSWER_TO_EDIT:{const{answer:n}=l.payload,{topId:i,id:a,parentId:w}=n;return{...s,keyExpanded:{topId:i,groupId:w,answerId:a},activeAnswer:n,formMode:E.EditingAnswer,selectedAnswerId:n.id,loadingAnswer:!1,answerLoaded:!0}}case o.ANSWER_DELETED:return{...s,activeAnswer:null,selectedAnswerId:null,formMode:E.None,loadingAnswer:!1,answerLoaded:!0};case o.CANCEL_ANSWER_FORM:case o.CLOSE_ANSWER_FORM:return{...s,formMode:E.None,activeAnswer:null,selectedAnswerId:null};default:return alert(`Action ${l.type} not allowed`),{...s}}};class J{static idToSet;static newGroupRow;constructor(l){const{topId:u,id:n,parentId:i,title:a,link:w,kind:y,header:G,level:_,variations:r,numOfAnswers:R,hasSubGroups:j,groupRows:T,created:b,modified:D,answerRows:k,isExpanded:$}=l,A=T.map(I=>(console.log("DeepClone >>>>>>>>>>>>>>>",I.id),I.id===J.idToSet?{...J.newGroupRow}:new J(I).groupRow));this.groupRow={topId:u,parentId:i,id:n,kind:y,title:a,link:w,header:G,level:_,hasSubGroups:j,groupRows:A,numOfAnswers:R,answerRows:k,variations:r??[],created:b,modified:D,isExpanded:$}}groupRow}const He=x.createContext({}),qe=x.createContext(()=>null),Cs={formMode:E.None,allGroupRows:new Map,allGroupRowsLoaded:void 0,topRows:[],topRowsLoading:!1,topRowsLoaded:!1,nodeOpening:!1,nodeOpened:!1,keyExpanded:null,groupId_answerId_done:void 0,activeGroup:null,activeAnswer:null,selectedAnswerId:null,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1,error:void 0,rowExpanding:!1,rowExpanded:!1},Ps=({children:s})=>{const{loadAndCacheAllGroupRows:l}=Pe(),u=se(),{KnowledgeAPI:n,isAuthenticated:i,workspace:a,authUser:w,canEdit:y}=u,{nickName:G}=w,[_,r]=x.useReducer(Ds,Cs),{formMode:R,activeGroup:j,activeAnswer:T,keyExpanded:b,topRows:D,allGroupRows:k,allGroupRowsLoaded:$}=_;console.log("----->>> ----->>> ----->>> GroupProvider"),x.useEffect(()=>{let d=a==="SLINDZA"?{topId:"MTS",groupId:"MTS",answerId:"aaaaaa111"}:{topId:"MTS",groupId:"REMOTECTRLS",answerId:"aaaaaa111"};if("localStorage"in window){let t=localStorage.getItem("GROUPS_STATE");if(console.log("GROUPS_STATE loaded before signIn",t),t!==null){const g=JSON.parse(t);g.keyExpanded!==null&&(d=g.keyExpanded)}}r({type:o.SET_FROM_LOCAL_STORAGE,payload:{keyExpanded:d}})},[a]);const A=x.useCallback(async(d,t,g=null,c=void 0)=>{const p=localStorage.getItem("accessToken");if(p)try{console.log("------Execute endpoint:",t);let m=null;const h=new Headers,N=`Bearer ${p}`;h.append("Authorization",N),g&&h.append("Content-Type","application/json");let P={method:d,headers:h,body:g?JSON.stringify(g):null};if(m=await fetch(t,P),m.ok){if(m.status===200||m.status===201){let W=null;try{W=await m.json()}catch{r({type:o.SET_GROUP_ERROR,payload:{error:new Error(`Response status: ${m.status}`),whichRowId:c}})}finally{return W}}}else{const{errors:W}=await m.json(),Z=new Error(W?.map(Y=>Y.message).join(`
`)??"unknown");r({type:o.SET_GROUP_ERROR,payload:{error:Z,whichRowId:c}})}}catch(m){console.log("-------------->>> execute",d,t,m),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("fetch eror"),whichRowId:c}})}return null},[]),I=x.useCallback(async()=>new Promise(async d=>{const t=await l();t&&r({type:o.SET_ALL_GROUP_ROWS,payload:{allGroupRows:t}}),d(t)}),[A,n.endpointGroupRow,a]),B=x.useCallback(async d=>{try{return k.get(d)}catch(t){console.log(t),r({type:o.SET_GROUP_ERROR,payload:{error:t}})}},[k]);x.useEffect(()=>{(async()=>$===void 0&&await I())()},[$,I]);const S=x.useCallback(async d=>{try{let t="";const g=[];return k.forEach((c,p)=>{p===d?t="":c.parentId===d&&g.push(c)}),{subCats:g,parentHeader:t}}catch(t){return console.log(t),r({type:o.SET_GROUP_ERROR,payload:{error:t}}),{subCats:[],parentHeader:"Kiks subCats"}}},[k]),O=x.useCallback(async()=>new Promise(async d=>{try{r({type:o.SET_TOP_ROWS_LOADING,payload:{}});const t=`${n.endpointGroupRow}/${a}/null/topRows/all`;console.log("GroupProvider loadTopRows url:",t),console.log("loadTopRows AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"),console.time(),await A("GET",t).then(g=>{console.timeEnd(),console.log("loadTopRows BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");const c=g.map(p=>(p.IsExpanded=b?p.Id===b.groupId:!1,new Re(p).groupRow));r({type:o.SET_TOP_ROWS,payload:{topRows:c}}),d(!0)})}catch(t){console.log(t),r({type:o.SET_GROUP_ERROR,payload:{error:t}})}}),[A,n.endpointGroupRow,b,a]),U=x.useCallback(async(d,t)=>{const{topId:g,id:c}=d;return console.log({groupKey:d,includeAnswerId:t}),new Promise(async p=>{try{const m=`${n.endpointGroup}/${a}/${g}/${c}/${pe}/${t}`;console.time(),console.log("================ getGroup ======================="),await A("GET",m).then(h=>{console.timeEnd();const{groupDto:N,msg:P}=h;p(N?new me(N).group:new Error(P))})}catch(m){console.log(m),p(m)}})},[A,n.endpointGroup,a]),C=x.useCallback((d,t)=>{if(d.topId===t)return d;const{groupRows:g}=d;let c=g.find(p=>p.id===(t??"null"));if(!c)try{g.forEach(p=>{if(console.log(t,p.id),c=C(p,t),c)throw new Error("Stop the loop")})}catch{}return c},[]),f=x.useCallback(async(d,t,g="false")=>new Promise(async()=>{try{let{topId:c,parentId:p,id:m}=d;if(console.assert(m!==null,"id ne sme biti null u expandNodesUpToTheTree"),m){const W=k.get(m);W?(d.topId=W.topId,d.parentId=W.parentId):alert("reload all groupRow:"+m)}r({type:o.SET_NODE_EXPANDING_UP_THE_TREE,payload:{id:m,questionId:t}}),console.time();const h={topId:c,id:m,parentId:null},N=new re(h).toQuery(a),P=`${n.endpointGroupRow}?${N}&pageSize=${pe}&includeAnswerId=${t??null}`;await A("GET",P).then(async W=>{const{groupRowDto:Z}=W;if(console.timeEnd(),Z){let Y=null,de=null,oe=new Re(Z).groupRow;if(p!==null){const we=C(oe,m);if(Y={...we,doc1:""},t){const be=we.answerRows.find(De=>De.id===t&&De.included);be&&(Y=null,de={...be,source:0,status:0})}}console.log(">>> expandNodeUpToTheTree groupRow",{groupRow:oe,answerId:"'"+(t??"jok")+"'"+(t??"JOK")});const fe=t?y?E.EditingAnswer:E.ViewingAnswer:y?E.EditingGroup:E.ViewingGroup;r({type:o.SET_NODE_EXPANDED_UP_THE_TREE,payload:{grpKey:d,groupRow:oe,group:Y,answerId:t??null,answer:de,formMode:fe,fromChatBotDlg:g==="true"}})}})}catch(c){console.log(c),r({type:o.SET_GROUP_ERROR,payload:{error:c}})}}),[a,n.endpointGroupRow,A,k,C,y]),q=x.useCallback(async(d,t=!1,g=null)=>{const c=new re(d).toQuery(a);return new Promise(async p=>{try{const m=`${n.endpointGroupRow}/${t}/${pe}/${g}?${c}`;console.time(),await A("GET",m).then(h=>{console.timeEnd();const{groupRowDto:N,msg:P}=h;p(N?new Re(N).groupRow:new Error(P))})}catch(m){console.log(m),p(m)}})},[A,n.endpointGroupRow,a]),F=x.useCallback(async({groupKey:d,includeAnswerId:t,newAnswerRow:g,formMode:c})=>{try{r({type:o.SET_ROW_EXPANDING,payload:{}});const p=await q(d,!0,t);if(p instanceof Error)r({type:o.SET_GROUP_ERROR,payload:{error:p}}),console.error({cat:p});else{let m;return t&&p.answerRows.filter(h=>h.included).length>0&&(m=t),g&&(p.answerRows=[g,...p.answerRows]),p.isExpanded=!0,console.log("@@@@@@@@@@@@@@@@@ expandGroup:",c,t),c===E.None&&t&&(c=y?E.EditingAnswer:E.ViewingAnswer),r({type:o.SET_ROW_EXPANDED,payload:{groupRow:p,formMode:c,selectedAnswerId:m}}),p}}catch(p){return console.log("error",p),r({type:o.SET_GROUP_ERROR,payload:{error:p}}),null}},[y,q]),L=x.useCallback(async d=>{const{topId:t,id:g}=d,c=D.find(m=>m.id===t);d={...c.id===g?c:C(c,g),isExpanded:!1,groupRows:[],answerRows:[]},r({type:o.SET_ROW_COLLAPSED,payload:{groupRow:d}})},[C,D]),H=x.useCallback(async d=>{try{r({type:o.CLOSE_GROUP_FORM,payload:{}});const{topId:t,id:g,parentId:c,level:p}=d??{topId:"generateId",id:"generateId",parentId:null,level:0},m={...ze,topId:t,parentId:d?g:c,id:"generateId",level:p+1,title:"",isExpanded:!1};if(d===null)r({type:o.SET_GROUP_TO_ADD_TOP,payload:{newGroupRow:m}});else{const h={...d,level:p+1,groupRows:[m,...d.groupRows],hasSubGroups:!0,isExpanded:!0};r({type:o.SET_GROUP_TO_ADD,payload:{groupRow:h,newGroupRow:m}})}}catch(t){console.log("error",t),r({type:o.SET_GROUP_ERROR,payload:{error:t}})}},[]),V=x.useCallback(async()=>{try{const{topId:d,id:t,parentId:g}=j,p={groupKey:{topId:d,parentId:g,id:t},formMode:E.None},m=await F(p);m&&r({type:o.CANCEL_ADD_SUB_GROUP,payload:{groupRow:m}})}catch(d){console.log("error",d),r({type:o.SET_GROUP_ERROR,payload:{error:d}})}},[j,F]),K=x.useCallback(async d=>{const{id:t}=d;r({type:o.SET_LOADING_GROUP,payload:{}});try{const g=new ke(d,a).groupDto;console.log("groupDto",{groupDto:g});const c=`${n.endpointGroup}`;console.time(),await A("POST",c,g,t).then(async p=>{console.timeEnd();const{groupDto:m}=p;if(m){const h=new me(m).group;console.log("Group successfully created",{group:h}),await I().then(async()=>{await O(),h.parentId===null?r({type:o.SET_GROUP_ADDED,payload:{groupRow:h}}):r({type:o.SET_GROUP_ADDED,payload:{groupRow:h}})})}})}catch(g){console.log(g),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:t}})}},[A,n.endpointGroup,I,O,a]),M=x.useCallback(async()=>{try{const{topId:d,parentId:t}=T,c={groupKey:{topId:d,parentId:t,id:t},formMode:E.None},p=await F(c);p&&r({type:o.CANCEL_ADD_ANSWER,payload:{groupRow:p}})}catch(d){console.log("error",d),r({type:o.SET_GROUP_ERROR,payload:{error:d}})}},[T,F]),ne=x.useCallback(async(d,t)=>{R===E.AddingAnswer?await M():R===E.AddingGroup&&await V(),r({type:o.SET_LOADING_GROUP,payload:{groupRow:d}});const g=new re(d).groupKey,c=await U(g,t);c instanceof Error?r({type:o.SET_GROUP_ERROR,payload:{error:c}}):(c.topId=d.topId,r({type:o.SET_GROUP_TO_VIEW,payload:{groupRow:c}}))},[V,M,R,U]),Q=x.useCallback(async(d,t)=>{R===E.AddingAnswer?await M():R===E.AddingGroup&&await V(),r({type:o.SET_LOADING_GROUP,payload:{}});const g=new re(d).groupKey,c=await U(g,t);if(c instanceof Error)r({type:o.SET_GROUP_ERROR,payload:{error:c}});else{const p={...c,isExpanded:!1,groupRows:[],answerRows:[]};r({type:o.SET_GROUP_TO_EDIT,payload:{groupRow:p,group:c}})}},[V,M,R,U]),le=x.useCallback(async d=>{r({type:o.SET_LOADING_GROUP,payload:{}});try{const t=new ke(d,a).groupDto,g=`${n.endpointGroup}`;console.time(),await A("PUT",g,t).then(c=>{console.timeEnd();const{groupDto:p,msg:m}=c;if(p){const h=new me(p).group,{topId:N}=h;h.isExpanded=!1,h.topId=N,r({type:o.SET_GROUP_UPDATED,payload:{group:h}})}else r({type:o.SET_GROUP_ERROR,payload:{error:new Error(`${m}`)}})})}catch(t){return console.log(t),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Karambol")}}),t}},[A,n.endpointGroup,a]),rs=x.useCallback(async d=>{try{const{topId:t,parentId:g}=d,c=new fs(d,a).groupRowDto,p=`${n.endpointGroup}`;console.time(),await A("DELETE",p,c).then(async m=>{console.timeEnd();const{groupDto:h,msg:N}=m;N==="OK"?(console.log("Group successfully deleted",{groupRow:d}),await I().then(async()=>{const P={groupKey:{topId:t,parentId:"",id:g},formMode:E.None};g?await O():await F(P).then(()=>{})})):r(N==="HasSubGroups"?{type:o.SET_GROUP_ERROR,payload:{error:new Error("First remove sub groups"),whichRowId:h.Id}}:N==="HasAnswers"?{type:o.SET_GROUP_ERROR,payload:{error:new Error("First remove group answers"),whichRowId:h.Id}}:{type:o.SET_GROUP_ERROR,payload:{error:new Error(N),whichRowId:h.Id}})})}catch(t){return console.log(t),t}},[A,n.endpointGroup,F,I,O,a]),ts=async(d,t)=>{try{console.log("Deleting Group Tag...",{groupKey:d,variationName:t}),console.log("Group Tag successfully deleted")}catch(g){console.log("error",g),r({type:o.SET_GROUP_ERROR,payload:{error:g}})}},pe=12,as=x.useCallback(async({groupKey:d,startCursor:t,includeAnswerId:g})=>{try{const{topId:c,id:p}=d;r({type:o.SET_ANSWERS_LOADING,payload:{}});try{const m=`${n.endpointAnswer}/${a}/${c}/${p}/${t}/${pe}/${g}`;console.time(),await A("GET",m).then(h=>{console.timeEnd();const{groupDto:N}=h;if(N!==null){const P=new me(N).group;r({type:o.GROUP_ANSWERS_LOADED,payload:{groupRow:P}})}})}catch(m){console.log(m),r({type:o.SET_GROUP_ERROR,payload:{error:m}})}}catch(c){console.log(c),r({type:o.SET_GROUP_ERROR,payload:c})}},[A,n.endpointAnswer,a]),ls=x.useCallback(async(d,t)=>{try{const{topId:g,id:c}=d;let p=await B(c);if(!p){alert(`Not found ${c}. Reload all Groups`);return}const m={topId:g,parentId:d.id,id:"generateId",title:"answer text",groupTitle:p.title,included:!0},h={..._e,...m,title:""};if(console.assert(t),t){const N=_.topRows.find(W=>W.id===g),P=C(N,c);P.answerRows=[m,...P.answerRows],r({type:o.ADD_NEW_ANSWER_TO_ROW,payload:{groupRow:P,newAnswerRow:m}}),r({type:o.SET_ANSWER,payload:{answer:h,formMode:E.AddingAnswer}})}}catch(g){console.log("error",g),r({type:o.SET_GROUP_ERROR,payload:{error:g}})}},[F,C,B,_.topRows]),ds=x.useCallback(async d=>{const{topId:t,id:g,parentId:c}=d;r({type:o.SET_LOADING_GROUP,payload:{}});try{d.created.nickName=G;const p=new Ce(d,a).answerDto,m=`${n.endpointAnswer}`;console.time(),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> createAnswer",p),await A("POST",m,p).then(async h=>{if(console.timeEnd(),h){console.log("::::::::::::::::::::",{answerDtoEx:h});const{answerDto:N}=h;if(N){const P=new Ee(N).answer;P.topId=t,console.log("Answer successfully created"),await I().then(async()=>{const Z={groupKey:{topId:t,parentId:c,id:c},formMode:E.EditingAnswer};await F(Z).then(()=>{r({type:o.SET_ANSWER,payload:{formMode:E.EditingAnswer,answer:P}})})})}}})}catch(p){console.log(p),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[A,n.endpointAnswer,F,I,G,a]),is=x.useCallback(async(d,t,g)=>{const{id:c}=t;try{t.modified.nickName=G;const p=new Ce(t,a).answerDto,m=`${n.endpointAnswer}`;console.time(),p.oldParentId=d,console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> updateAnswer",p);let h=null;return await A("PUT",m,p).then(async N=>{console.timeEnd();const{answerDto:P,msg:W}=N;if(P){h=new Ee(P).answer,console.log("Answer successfully updated: ",h);const{topId:Z,parentId:Y}=h;if(g){const{topId:de,parentId:oe,id:fe}=h,we={topId:de,groupId:oe,answerId:fe};r({type:o.FORCE_GROUP_OPEN_NODE,payload:{keyExpanded:we}})}else{const oe={groupKey:{topId:Z,parentId:Y,id:Y},formMode:E.EditingAnswer};await F(oe).then(()=>{r({type:o.SET_ANSWER,payload:{formMode:E.EditingAnswer,answer:h}})})}}else r({type:o.SET_GROUP_ERROR,payload:{error:new Error(W)}})}),h}catch(p){console.log(p),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:c}})}},[A,n.endpointAnswer,F,G,a]),cs=x.useCallback(async(d,t)=>{const{id:g,parentId:c,topId:p}=d;r({type:o.SET_LOADING_ANSWER,payload:{}});try{const m=new Rs(d,a).answerRowDto,h=`${n.endpointAnswer}`;console.time(),await A("DELETE",h,m).then(async N=>{const{answerDto:P}=N;if(console.timeEnd(),P){const W=new Ee(P).answer;console.log("Answer successfully deleted"),t&&r({type:o.ANSWER_DELETED,payload:{answer:W}});const Y={groupKey:{topId:p,parentId:c,id:c},formMode:E.None};await F(Y).then(()=>{})}else console.error(N),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})})}catch(m){console.log(m),r({type:o.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[A,n.endpointAnswer,F,a]),ue=x.useCallback(async d=>new Promise(async t=>{try{const g=new he(d).toQuery(a),c=`${n.endpointAnswer}?${g}`;console.time(),console.log("getAnswer",d),await A("GET",c).then(p=>{console.timeEnd();const{answerDto:m,msg:h}=p;if(m){const N={answer:new Ee(m).answer,msg:h};t(N)}else t({answer:null,msg:h})})}catch(g){console.log(g),t({answer:null,msg:"Problemos"})}}),[A,n.endpointAnswer,a]),ps=x.useCallback(async d=>{const t=new he(d).answerKey;r({type:o.SET_LOADING_ANSWER,payload:{}});const g=await ue(t);R===E.AddingAnswer?await M():R===E.AddingGroup&&await V();const{answer:c,msg:p}=g;c?(c.topId=d.topId,r({type:o.SET_ANSWER_TO_VIEW,payload:{answer:c}})):r({type:o.SET_GROUP_ERROR,payload:{error:new Error(p)}})},[V,M,R,ue]),us=x.useCallback(async d=>{const t=new he(d).answerKey;R===E.AddingAnswer?await M():R===E.AddingGroup&&await V(),r({type:o.SET_LOADING_ANSWER,payload:{}}),console.log("editAnswer:",t);const g=await ue(t),{answer:c,msg:p}=g;c?(c.topId=d.topId,r({type:o.CLOSE_ANSWER_FORM,payload:{answer:c}}),r({type:o.SET_ANSWER_TO_EDIT,payload:{answer:c}})):r({type:o.SET_GROUP_ERROR,payload:{error:new Error(p)}})},[V,M,R,ue]),ws=x.useCallback((d,t)=>{console.log("Provider onGroupTitleChanged:",t),r({type:o.GROUP_TITLE_CHANGED,payload:{groupRow:{...d,title:t}}})},[]),gs=x.useCallback((d,t,g)=>{const{parentId:c,id:p}=t,m=C(d,c);if(m){const h=m.answerRows.find(N=>N.id===p);h.title=g,console.log("onAnswerTitleChanged+++>>>",p,m),r({type:o.ANSWER_TITLE_CHANGED,payload:{groupRow:m}})}},[C]),ms={state:_,loadAllGroupRows:I,getSubGrps:S,getGrp:B,expandNodesUpToTheTree:f,loadTopRows:O,addSubGroup:H,cancelAddGroup:V,createGroup:K,viewGroup:ne,editGroup:Q,updateGroup:le,deleteGroup:rs,deleteGroupVariation:ts,expandGroup:F,collapseGroup:L,onGroupTitleChanged:ws,loadGroupAnswers:as,addAnswer:ls,cancelAddAnswer:M,createAnswer:ds,viewAnswer:ps,editAnswer:us,updateAnswer:is,deleteAnswer:cs,onAnswerTitleChanged:gs};return!i||!$||b===null?null:e.jsx(He.Provider,{value:ms,children:e.jsx(qe.Provider,{value:r,children:s})})};function z(){return x.useContext(He)}const ve=()=>x.useContext(qe),Ls="/knowledge/assets/APlus-sw4jpCsS.png";var ee=(s=>(s.SET_LOADING="SET_LOADING",s.SET_SUB_CATS="SET_SUB_CATS",s.SET_ERROR="SET_ERROR",s.SET_EXPANDED="SET_EXPANDED",s.SET_PARENT_CAT="SET_PARENT_CAT",s))(ee||{});const Us=({cat:s,dispatch:l,setParentGrp:u,selId:n})=>{const{topId:i,parentId:a,id:w,title:y,level:G,isExpanded:_}=s,r={topId:i,parentId:a,id:w},R=b=>{l({type:ee.SET_EXPANDED,payload:{id:w,expanding:!_}})},j=b=>{u(b)},T=e.jsxs("div",{className:"d-flex justify-content-start align-items-center w-100 text-primary",children:[e.jsx(X,{variant:"link",size:"sm",className:"py-0 px-1",onClick:b=>{R(),b.stopPropagation(),b.preventDefault()},title:"Expand",children:e.jsx(te,{icon:_?Ue:Me,size:"lg"})}),e.jsx(X,{variant:"link",size:"sm",className:"py-0 mx-0 text-decoration-none",title:w,onClick:()=>j(s),children:y})]});return e.jsxs(e.Fragment,{children:[e.jsx(ae.Item,{variant:"primary",className:"py-0 px-1 w-100",as:"li",children:T}),_&&e.jsx(ae.Item,{className:"py-0 px-0",variant:"primary",as:"li",children:e.jsx(Qe,{selId:n,level:G+1,groupKey:r,setParentId:u})})]})},Ms={loading:!1,parentId:null,title:"",cats:[]},Fs=(s,l)=>{switch(l.type){case ee.SET_LOADING:return{...s,loading:!0};case ee.SET_SUB_CATS:{const{subGrps:u}=l.payload;return{...s,cats:s.cats.concat(u),loading:!1}}case ee.SET_ERROR:{const{error:u}=l.payload;return{...s,error:u,loading:!1}}case ee.SET_EXPANDED:{const{id:u,expanding:n}=l.payload;let{cats:i}=s;if(!n){const a=Xe(i,u);console.log("clean:",a),a.length>0&&(i=i.filter(w=>!a.includes(w.id)))}return{...s,cats:s.cats.map(a=>a.id===u?{...a,isExpanded:n}:a)}}case ee.SET_PARENT_CAT:{const{cat:u}=l.payload,{id:n,title:i}=u;return{...s,parentId:n,title:i}}default:return s}};function Xe(s,l){let u=s.filter(n=>n.parentId===l).map(n=>n.id);return u.forEach(n=>{const i=n?Xe(s,n):[];u=u.concat(i)}),u}const Qe=({selId:s,groupKey:l,level:u,setParentId:n})=>{const[i,a]=x.useReducer(Fs,Ms),{getSubGrps:w}=z(),{id:y}=l??{id:null},[G]=x.useState(l);x.useEffect(()=>{(async()=>{const R=await w(y),{subGrps:j}=R;a({type:ee.SET_SUB_CATS,payload:{subGrps:j}})})()},[w,G,y]);const _=i.cats.filter(R=>R.parentId===y),r=R=>{a({type:ee.SET_PARENT_CAT,payload:{cat:R}}),n(R)};return e.jsxs("div",{className:u>1?"border  border-7 ms-4 h-25":"border border-7  h-25",style:{overflowY:"auto"},children:[e.jsx(ae,{as:"ul",variant:"dark",className:"mb-0",children:_.filter(R=>R.id!==s).map(R=>e.jsx(Us,{cat:R,selId:s,dispatch:a,setParentGrp:r},R.id))}),i.error&&i.error.message]})},Oe=({answer:s,submitForm:l,children:u,showCloseButton:n,source:i=0,closeModal:a})=>{const{state:w,onAnswerTitleChanged:y}=z();let{formMode:G,topRows:_}=w;const r=G===E.ViewingAnswer,R=G===E.EditingAnswer,j=G===E.AddingAnswer,T=r,{topId:b,id:D,title:k}=s,$=ve(),A=()=>{a?a():$({type:o.CLOSE_ANSWER_FORM,payload:{answer:s}})},I=()=>{a?a():$({type:o.CANCEL_ANSWER_FORM,payload:{answer:s}})},[B,S]=x.useState(D+"/"+k),O=Fe(B,500),[U]=x.useState(_.find(L=>L.id===b)),C=x.useRef(null),f=Be({enableReinitialize:!0,initialValues:s,validationSchema:$e().shape({title:Ae().required("Required"),parentId:Ae().required("Required").notOneOf(["000000000000000000000000"])}),onSubmit:L=>{l(L),S(L.id+"/"+L.title)}});x.useEffect(()=>{(async()=>{const H=O.split("/"),V=H[0];if(f.values.id===V){console.log("AnswerForm.useEffect - onQuestioTitleChanged",{debouncedSearchTerm:O,searchTerm:B,title:f.values.title});const K=H[1];await y(U,f.values,K)}})()},[O,f.values,y,B,U]),x.useEffect(()=>{C.current.focus(),i!==0&&f.setFieldValue("source",i)},[f,C,i]);const q=L=>{f.handleChange(L);const H=L.target.value;S(D+"/"+H)},F=L=>{f.setFieldValue("parentId",L.id),f.setFieldValue("groupTitle",L.title)};return console.log("@@@@@@@@@@@@@@@@@@@@@ AnswerForm.render: ",{searchTerm:B,qTitle:k,debouncedSearchTerm:O}),e.jsxs("div",{className:"form-wrapper px-3 py-1 my-0 my-1 w-100 answer-form",children:[n&&e.jsx(Le,{onClick:A,className:"float-end"}),e.jsx(ce,{className:"text-center",children:e.jsxs(v.Label,{children:["Answer  ",r?"Viewing":R?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:f.handleSubmit,children:[e.jsxs(Se,{direction:"horizontal",gap:0,className:"border",children:[e.jsx("div",{className:"p-0",children:e.jsx(v.Label,{children:"Group:"})}),e.jsx("div",{className:"p-1",children:e.jsxs(v.Group,{controlId:"parentId",className:"group-select form-select-sm w-90",children:[e.jsxs(ye,{children:[e.jsx(ye.Toggle,{variant:"light",id:"dropdown-basic",className:"px-2 py-0 text-primary border",disabled:T,children:e.jsx("span",{className:"text-wrap me-1",children:f.values.groupTitle})}),e.jsx(ye.Menu,{className:"p-0 border",children:e.jsx(ye.Item,{className:"p-0 m-0 rounded-3",children:e.jsx(Qe,{selId:f.values.parentId,groupKey:null,level:1,setParentId:F})})})]}),e.jsx(v.Control,{as:"input",name:"parentId",onChange:f.handleChange,value:f.values.parentId?f.values.parentId:"",placeholder:"Group",className:"text-primary w-100",disabled:T,hidden:!0}),e.jsx(v.Text,{className:"text-danger",children:f.touched.parentId&&f.errors.parentId?e.jsx("div",{className:"text-danger",children:f.errors.parentId?"required":""}):null})]})})]}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:f.values.title==="new Answer"?"new Answer":"answer text",ref:C,onChange:q,value:f.values.title,rows:3,className:"text-primary w-100",disabled:T}),e.jsx(v.Text,{className:"text-danger",children:f.touched.title&&f.errors.title?e.jsx("div",{className:"text-danger",children:f.errors.title}):null})]}),e.jsxs(ce,{children:[e.jsx(ie,{children:e.jsxs(v.Group,{controlId:"source",children:[e.jsx(v.Label,{children:"Source"}),e.jsx(Ge,{id:"source",name:"source",options:_s,onChange:(L,H)=>{L.preventDefault(),f.setFieldValue("source",H)},value:f.values.source,disabled:T,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:f.touched.source&&f.errors.source?e.jsx("div",{className:"text-danger",children:f.errors.source}):null})]})}),e.jsx(ie,{children:e.jsxs(v.Group,{controlId:"status",children:[e.jsx(v.Label,{children:"Status"}),e.jsx(Ge,{id:"status",name:"status",options:Ss,onChange:(L,H)=>{L.preventDefault(),f.setFieldValue("status",H)},value:f.values.status,disabled:T,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:f.touched.status&&f.errors.status?e.jsx("div",{className:"text-danger",children:f.errors.status}):null})]})})]}),(r||R)&&e.jsx("div",{className:"my-1",children:e.jsx(We,{created:s.created,modified:s.modified,classes:"text-primary"})}),(f.dirty&&R||j)&&e.jsx(Ve,{cancelForm:I,handleSubmit:f.handleSubmit,title:u}),w.error&&e.jsx("div",{className:"text-danger",children:w.error.message})]})]})},je=({closeModal:s,showCloseButton:l,source:u,setError:n})=>{const{state:i,cancelAddAnswer:a,createAnswer:w}=z(),{activeAnswer:y}=i,G=y?y.topId:"",_=async()=>{await a()},r=async R=>{const j={...R,topId:G,created:{time:new Date,nickName:""},modified:void 0},T=await w(j,s!==void 0);T&&(T.message?n(T.message):s&&s())};return y?e.jsx(Oe,{answer:y,showCloseButton:l??!0,source:u??0,closeModal:_,submitForm:r,children:"Create Answer"}):null},Je=({})=>{const{state:s,updateAnswer:l}=z(),{activeAnswer:u}=s;if(!u)return null;if(!u)return e.jsx("div",{children:"Loading answer to edit..."});const n=async i=>{const a={...i,created:void 0,modified:{time:new Date,nickName:""}},{parentId:w}=u,y=w!==a.parentId;await l(w,a,y)};return e.jsx(Oe,{answer:u,showCloseButton:!0,source:0,submitForm:n,children:"Update Answer"})},Ze=({inLine:s})=>{console.log(s?"ViewAnswer inLine":"ViewAnswer not inLine");const{state:l}=z(),{activeAnswer:u}=l,[n,i]=x.useState(null);return x.useEffect(()=>{console.log("#################################### ViewAnswer setAnswer ...",{activeAnswer:u}),i(u)},[u]),e.jsx(Oe,{answer:n,showCloseButton:!0,source:0,submitForm:()=>{},children:"View Answer"})},Bs=({answerRow:s,isSelected:l})=>{const{id:u,topId:n,parentId:i,title:a}=s,w={topId:n,parentId:i,id:i},{canEdit:y,authUser:G}=se(),{state:_,viewAnswer:r,addAnswer:R,editAnswer:j,deleteAnswer:T}=z(),{activeAnswer:b,formMode:D,loadingAnswer:k,answerLoaded:$}=_,A=b!==null&&b.id===u,I=D===E.AddingAnswer,B=()=>{s.modified={time:new Date,nickName:G.nickName},T(s,A)},S=async f=>{console.log("AnswerRow onSelectAnswer",{id:f}),y?await j(s):await r(s)},[O,U]=Te();x.useEffect(()=>{(async()=>{if(l&&!k&&!$){switch(D){case E.ViewingAnswer:await r(s);break;case E.EditingAnswer:console.log("Zovem from AnswerRow"),y?await j(s):await r(s);break}document.getElementById(`AnswerRow${u}`)?.scrollIntoView({behavior:"smooth",block:"end"})}})()},[y,j,D,u,l,k,$,s,r]);const C=e.jsxs("div",{id:`AnswerRow${u}`,className:`d-relative d-flex justify-content-start align-items-center w-100 answer-row${l?"-selected":""}`,style:{marginTop:"0px"},children:[e.jsx(X,{variant:"link",size:"sm",className:"d-flex align-items-center px-1 text-secondary",children:e.jsx("img",{width:"22",height:"18",src:hs,alt:"Answer"})}),e.jsx(X,{variant:"link",size:"sm",className:`p-0 px-1 m-0 ms-0 answer-row-title ${A?"fw-bold":""}`,title:`id:${u.toString()}`,onClick:()=>S(u),disabled:I,children:a}),y&&!I&&U&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx(X,{variant:"link",size:"sm",className:"ms-1 p-0 text-secondary d-flex align-items-center",title:"Add Answer",onClick:()=>{R(w,!0)},children:e.jsx("img",{width:"22",height:"18",src:Ts,alt:"Add Answer"})}),e.jsx(X,{variant:"link",size:"sm",className:"ms-0 p-0 text-secondary",onClick:B,children:e.jsx(te,{icon:Ne,size:"lg"})})]})]});return e.jsxs(ae.Item,{className:"py-0 px-0 w-100",as:"li",children:[l&&D===E.AddingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(je,{showCloseButton:!0,source:0})}),e.jsx("div",{ref:O,className:"d-none d-md-block  border rounded-3",children:C})]}),l&&D===E.EditingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:O,className:"",children:C}),e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(Je,{inLine:!0})})]}),l&&D===E.ViewingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:O,className:"",children:C}),e.jsx("div",{ref:O,id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(Ze,{inLine:!0})})]}),!l&&e.jsx("div",{ref:O,className:"",children:C})]})},Ye=({groupRow:s})=>{const{state:l,loadGroupAnswers:u}=z(),{keyExpanded:n,loadingAnswer:i,error:a,selectedAnswerId:w}=l,{answerId:y}=n;s.level+=1;const{answerRows:G}=s;let _=!1;async function r(){try{const T={groupKey:new re(s).groupKey,startCursor:G.length,includeAnswerId:y??null};console.log("^^^^^^^^^^^^^ loadMore"),console.log("^^^^^^^^^^^^^",{x:T}),console.log("^^^^^^^^^^^^^ loadMore"),await u(T)}catch{}}const[R,{rootRef:j}]=Ns({loading:i,hasNextPage:_,onLoadMore:r,disabled:!!a,rootMargin:"0px 0px 100px 0px"});return e.jsxs("div",{ref:j,className:"ms-0",style:{maxHeight:"400px",overflowY:"auto"},children:[e.jsxs(vs,{children:[G.length===0&&e.jsx("label",{children:"No answers"}),G.map(T=>e.jsx(Bs,{answerRow:T,isSelected:T.id===w},T.id)),_]}),a&&e.jsxs("p",{children:["Error: ",a.message]})]})},$s=({groupKey:s,tag:l,groupInAdding:u})=>{const{name:n}=l,{canEdit:i}=se(),{state:a,deleteGroupVariation:w}=z(),y=()=>{w(s,n)},[G,_]=Te(),r=e.jsxs("div",{ref:G,children:[e.jsx(Ke,{pill:!0,bg:"secondary",children:n}),i&&!0&&_&&e.jsx(X,{variant:"link",size:"sm",className:"ms-0 py-0 mx-0 text-secondary",onClick:y,children:e.jsx(te,{icon:Ne,size:"sm"})}),!1]});return e.jsx("div",{className:"py-1 px-1",children:r})},Ws=({groupKey:s,variations:l})=>{const{state:u}=z(),{error:n}=u;return x.useEffect(()=>{},[]),e.jsxs("div",{className:"ms-2",children:[e.jsxs(Se,{direction:"horizontal",gap:2,children:[l.length===0&&e.jsx("div",{children:"No variations"}),l.length>0&&l.map(i=>e.jsx($s,{groupKey:s,tag:i,groupInAdding:void 0}))]}),n&&e.jsxs("p",{children:["Error: ",n.message]})]})},Ie=({formMode:s,group:l,submitForm:u,children:n})=>{const{onGroupTitleChanged:i}=z(),a=s===E.ViewingGroup,w=s===E.EditingGroup,y=s===E.AddingGroup,{topId:G,id:_,variations:r,answerRows:R,title:j}=l;console.log("GroupForm render: ",{topId:G,id:_,catTitle:j,formMode:s});const T=new re(l).groupKey;document.getElementById("div-details");const b=R&&R.length>0,D=ve(),k=()=>{D({type:o.CLOSE_GROUP_FORM,payload:{}})},$=()=>{D({type:o.CANCEL_GROUP_FORM,payload:{}})},[A,I]=x.useState(j),B=Fe(A,300),S=Be({enableReinitialize:!0,initialValues:l,validationSchema:$e().shape({title:Ae().required("Required")}),onSubmit:f=>{console.log("GroupForm.onSubmit",JSON.stringify(f,null,2)),u(f),I(f.title)}});x.useEffect(()=>{(async()=>(console.log("GroupForm.useEffect - onGroupTitleChanged",{debouncedSearchTerm:B,title:S.values.title}),await i(S.values,B)))()},[B,S.values,i]);const O=f=>{S.handleChange(f);const q=f.target.value;I(q)},U=x.useRef(null);x.useEffect(()=>{U.current.focus()},[l.title,U]);const C=!1;return console.log("GroupForm render return: ",A),e.jsxs("div",{className:"form-wrapper p-2 group-form",children:[e.jsx(Le,{onClick:k,className:"float-end"}),e.jsx(ce,{className:"text-center text-muted",children:e.jsxs(v.Label,{children:["Group ",a?"Viewing":w?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:()=>S.handleSubmit,children:[e.jsx(v.Group,{controlId:"Variations",children:e.jsxs(Se,{direction:"horizontal",gap:1,children:[e.jsx("div",{className:"px-0",children:e.jsx(v.Label,{children:"Variations:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsx(Ws,{groupKey:T,variations:r?r.map(f=>({name:f})):[]})}),e.jsx("div",{className:"ps-2",children:e.jsx(v.Label,{children:"Kind:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsxs(v.Group,{controlId:"kind",children:[e.jsx(Ge,{id:"kind",name:"kind",options:Os,onChange:(f,q)=>{f.preventDefault(),S.setFieldValue("kind",q)},value:S.values.kind,disabled:C,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:S.touched.kind&&S.errors.kind?e.jsx("div",{className:"text-danger",children:S.errors.kind}):null})]})})]})}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:S.values.title==="new Group"?"new Group":"group text",value:A,onChange:O,ref:U,rows:3,className:"text-primary w-100",disabled:a}),e.jsx(v.Text,{className:"text-danger",children:S.touched.title&&S.errors.title?e.jsx("div",{className:"text-danger",children:S.errors.title}):null})]}),e.jsxs(v.Group,{controlId:"link",children:[e.jsx(v.Label,{children:"Link"}),S.values.hasSubGroups?e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:"Can't have link (has sub groups)",disabled:!0}):e.jsxs(e.Fragment,{children:[e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:S.values.link??"",disabled:a}),e.jsx(v.Text,{className:"text-danger",children:S.touched.link&&S.errors.link?e.jsx("div",{className:"text-danger",children:S.errors.link}):null})]})]}),e.jsxs(v.Group,{children:[e.jsxs(v.Label,{className:"m-1 mb-0",children:["Answers (",`${S.values.numOfAnswers}`,") "]}),b&&e.jsx(Ye,{groupRow:l})]}),(a||w)&&e.jsx(We,{created:l.created,modified:l.modified,classes:"text-primary"}),(S.dirty&&w||y)&&e.jsx(Ve,{cancelForm:$,handleSubmit:S.handleSubmit,title:n})]})]})},es=({inLine:s})=>{const l=se(),{nickName:u}=l.authUser,{state:n,updateGroup:i}=z(),{activeGroup:a,keyExpanded:w}=n,{answerId:y}=w,G=async _=>{const r={..._,created:void 0,modified:{time:new Date,nickName:u}};await i(r,!0)};return e.jsx(Ie,{inLine:s,group:{...a},answerId:y,formMode:E.EditingGroup,submitForm:G,children:"Update Group"})},ss=({inLine:s})=>{const{state:l}=z(),{activeGroup:u,keyExpanded:n}=l,{answerId:i}=n;return e.jsx(Ie,{inLine:s,group:{...u},answerId:i,formMode:E.ViewingGroup,submitForm:()=>{},children:"View Group"})},ns=({activeGroup:s})=>{const l=se(),{nickName:u}=l.authUser,{createGroup:n}=z(),[i]=x.useState({...s}),a=async w=>{const y={...w,created:{time:new Date,nickName:u},modified:void 0};console.log("**********object",y),await n(y)};return!s===null?null:(console.log("AddGroup render >>>>>:",s),e.jsx(e.Fragment,{children:e.jsx(Ie,{inLine:!1,group:i,answerId:null,formMode:E.AddingGroup,submitForm:a,children:"Create Group"})}))},Vs=({groupRow:s,answerId:l})=>{const{id:u,title:n,hasSubGroups:i,numOfAnswers:a,isExpanded:w}=s;s.level+=1;const y=new re(s).groupKey,{canEdit:G,authUser:_}=se(),{state:r,addSubGroup:R,viewGroup:j,editGroup:T,deleteGroup:b,expandGroup:D,collapseGroup:k,addAnswer:$}=z();let{formMode:A,activeGroup:I,loadingGroup:B,groupLoaded:S}=r;const O=I!==null&&I.id===u,U=A===E.AddingGroup,C=w&&a>0,f=()=>{s.modified={time:new Date,nickName:_.nickName},b(s)},q=async()=>{if(w)await k(s);else{const le={groupKey:y,byClick:!0,formMode:G?E.EditingGroup:E.ViewingGroup};await D(le)}},F=async()=>{G?await T(s,l??"null"):await j(s,l??"null")},[L,H]=x.useState(!1);x.useEffect(()=>{L&&(R(s),H(!1))},[R,s,L]);const[V,K]=x.useState(!1);x.useEffect(()=>{V&&($(y,w??!1),K(!1))},[$,y,w,V]),x.useEffect(()=>{(async()=>{if(O&&!B&&!S&&!U)switch(console.log("GroupRow formMode:",A),A){case E.ViewingGroup:await j(s,l??"null");break;case E.EditingGroup:G?await T(s,l??"null"):await j(s,l??"null");break}})()},[G,y,S,s,T,D,A,U,O,B,l,j]);const[M,ne]=Te(),Q=e.jsxs("div",{children:[e.jsxs("div",{id:`Row${u}`,className:`d-relative d-flex justify-content-start align-items-center w-100 group-row${O?"-selected":""}`,style:{marginTop:"1px"},children:[e.jsx(X,{variant:"link",size:"sm",className:"py-0 px-1",onClick:le=>{q(),le.stopPropagation()},title:"Expand",disabled:U||!i&&a===0,children:e.jsx(te,{icon:w?Ue:Me,size:"lg"})}),e.jsx(X,{variant:"link",size:"sm",className:"py-0 px-1 bg-light",title:"Expand",disabled:!0,children:e.jsx(te,{icon:js,size:"sm"})}),e.jsx(X,{variant:"link",size:"sm",className:`py-0 ms-0 me-1 group-row-title ${O?"fw-bold text-white bg-transparent":""}`,title:u,onClick:F,disabled:U,children:n}),a>0&&e.jsxs(Ke,{pill:!0,bg:"secondary",className:"d-inline bg-transparent",children:[a,"Q"]}),G&&ne&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx("div",{className:"d-flex align-items-center",children:e.jsx(X,{variant:"link",size:"sm",className:"border-0 py-0 px-0 ms-0 text-success",title:"Add SubGroup",onClick:async()=>{!w&&(i||a>0)&&await q(),setTimeout(()=>H(!0),500)},children:e.jsx(te,{icon:Is,size:"lg"})})}),!U&&!i&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(X,{variant:"link",size:"sm",className:"p-0 mx-0 text-secondary position-relative float-end d-flex align-items-center",title:"Add Answer",onClick:async()=>{!w&&(i||a>0)&&await q(),setTimeout(()=>K(!0),500)},children:e.jsx("img",{width:"22",height:"18",src:Ls,alt:"Add Answer"})}),e.jsx(X,{variant:"link",size:"sm",className:"p-0 ms-0 position-relative float-end d-flex align-items-center",disabled:i||a>0,onClick:f,children:e.jsx(te,{icon:Ne,size:"lg"})})]})]})]}),C&&e.jsx("div",{className:"ps-3",children:e.jsx(Ye,{groupRow:s})})]});return e.jsxs(e.Fragment,{children:[e.jsxs(ae.Item,{className:"py-0 px-1 w-100 group-bg",as:"li",children:[O&&A===E.AddingGroup&&e.jsxs("div",{children:[e.jsx("div",{ref:M,className:"",children:Q}),e.jsx("div",{className:"ms-0 d-md-none w-100",children:e.jsx(ns,{activeGroup:I})})]}),O&&A===E.EditingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:M,className:"",children:Q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(es,{inLine:!1})})]}),O&&A===E.ViewingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:M,className:"",children:Q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(ss,{inLine:!1})})]}),!O&&e.jsx("div",{ref:M,className:"",children:Q})]}),r.error&&r.whichRowId===u&&e.jsx("div",{className:"text-danger",children:r.error.message}),w&&e.jsx(ae.Item,{className:"py-0 px-0 border-0 border-warning border-bottom-0 group-bg",variant:"primary",as:"li",children:w&&e.jsx(e.Fragment,{children:i&&e.jsx(os,{groupRow:s,title:n,isExpanded:w})})})]})},os=({groupRow:s,title:l})=>{const{state:u}=z();let{keyExpanded:n}=u;const{answerId:i}=n??{answerId:null};let a=1,w=[];return l==="ROOT"?w=u.topRows:(w=s.groupRows,a=s.level),e.jsx("div",{className:a>1?"ms-2":"",children:e.jsx(ae,{as:"ul",variant:"dark",className:"mb-0 group-bg",children:w.map(y=>e.jsx(Vs,{groupRow:y,answerId:i},y.id))})})},Ks=s=>{const{isDarkMode:l}=se(),[u,n]=x.useState("");return x.useEffect(()=>{},[]),e.jsxs(xe,{show:s.show,onHide:s.onHide,animation:!0,centered:!0,size:"lg",className:"modal show",contentClassName:`${l?"bg-secondary bg-gradient":"bg-info bg-gradient"}`,children:[e.jsx(xe.Header,{closeButton:!0,children:"Store new Answer to the Database"}),e.jsx(xe.Body,{className:"py-0",children:e.jsx(je,{closeModal:s.onHide,showCloseButton:!1,source:1,setError:i=>n(i)})}),e.jsx(xe.Footer,{children:u})]})},zs=({groupId_answerId:s,fromChatBotDlg:l})=>{const{state:u,expandNodesUpToTheTree:n,loadTopRows:i,addSubGroup:a}=z(),{allGroupRows:w,topRows:y,topRowsLoading:G,topRowsLoaded:_,keyExpanded:r,groupId_answerId_done:R,nodeOpening:j,nodeOpened:T,activeGroup:b,activeAnswer:D,formMode:k,loadingGroups:$,loadingGroup:A,loadingAnswers:I,loadingAnswer:B}=u,{searchAnswers:S,setLastRouteVisited:O}=Pe(),{isDarkMode:U}=se(),[C,f]=x.useState(!1),[q,F]=x.useState({..._e}),L=ve(),H=async K=>{L({type:o.SET_ANSWER_SELECTED,payload:{answerKey:K}})};let V="";return x.useEffect(()=>{(async()=>!G&&!_&&(console.log("ZOVEM 111 loadTopRows()"),await i()))()},[G,_,i]),x.useEffect(()=>{(async()=>{if(!j&&y.length>0){if(s){if(s==="add_answer"){const K=localStorage.getItem("New_Answer");if(K){const M=JSON.parse(K);return F({..._e,groupTitle:"Select",...M}),f(!0),localStorage.removeItem("New_Answer"),null}}else if(s!==R){const K=s.split("_"),M=K[0],ne=K[1],Q={topId:"",id:M,parentId:"ROOT"};console.log("zovem expandNodesUpToTheTree 1111111111111111111)",{groupId_answerId:s},{groupId_answerId_done:R}),await n(Q,ne,l??"false").then(()=>null)}}else if(r&&!T){const{topId:K,groupId:M,answerId:ne}=r;if(M!==""){const Q={topId:K,id:M,parentId:"ROOT"};console.log("zovem expandNodeUpToTheTree 2222222222222)",{keyExpanded:r,grpKey:Q}),await n(Q,ne).then(()=>null)}}}})()},[r,j,T,n,s,R,y,l]),x.useEffect(()=>{O("/groups")},[O]),s!=="add_answer"&&s&&s!==R?(console.log("zzzzzz loading...",{keyExpanded:r,groupId_answerId:s,groupId_answerId_done:R}),e.jsx("div",{children:"loading..."})):!_||y.length===0?(console.log("===>>> Groups  VRATIO"),null):(console.log("===>>> Groups !!!!!!!!!!!!!!!!!",b),e.jsxs(e.Fragment,{children:[e.jsxs(Gs,{children:[e.jsxs("h5",{className:"text-warning mx-auto w-75 fw-bold",children:[e.jsx("span",{className:"groups",children:"Groups / "}),e.jsx("span",{className:"answers",children:"Answers"})]}),e.jsx(ce,{className:`${U?"dark":""}`,children:e.jsx(ie,{children:e.jsx("div",{className:"d-flex justify-content-start align-items-center",children:e.jsx("div",{className:"w-75 my-1 answers",children:e.jsx(bs,{tekst:V,onSelectAnswer:H,allGroupRows:w,searchAnswers:S})})})})}),e.jsx(X,{variant:"secondary",size:"sm",type:"button",style:{padding:"1px 4px"},onClick:()=>a(null),children:"Add Group"}),e.jsxs(ce,{className:"my-1 h-auto",children:[e.jsx(ie,{xs:12,md:5,children:e.jsx("div",{className:"groups-border",style:{position:"relative"},children:e.jsx(os,{groupRow:null,title:"ROOT",isExpanded:!0})})}),e.jsx(ie,{xs:0,md:7,children:e.jsxs("div",{id:"div-details",className:"d-none d-md-block",children:[b&&k===E.ViewingGroup&&e.jsx(ss,{inLine:!1}),b&&k===E.EditingGroup&&e.jsx(es,{inLine:!1}),b&&k===E.AddingGroup&&e.jsx(ns,{activeGroup:b}),D&&k===E.ViewingAnswer&&e.jsx(Ze,{inLine:!1}),D&&k===E.EditingAnswer&&e.jsx(Je,{inLine:!1}),D&&k===E.AddingAnswer&&e.jsx(je,{})]})})]})]}),C&&D&&e.jsx(Ks,{show:C,onHide:()=>{f(!1)},newAnswerRow:q}),($||I)&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"40%",left:"20%"},children:e.jsx("div",{className:`spinner-border ${I?"answer":"group"}-spinner`,role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),A&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border group-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),B&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border answer-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})]}))},Js=()=>{let{groupId_answerId:s,fromChatBotDlg:l}=As();if(s&&s==="groups"&&(s=void 0),s){const u=s.split("_");console.assert(u.length===2,"expected 'groupId_answerId'")}return e.jsx(Ps,{children:e.jsx(zs,{groupId_answerId:s,fromChatBotDlg:l})})};export{Js as default};
//# sourceMappingURL=Groups-BfCyS2ZX.js.map
