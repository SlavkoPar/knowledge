import{v as n,w as gs,x as ms,y as Es,z as E,E as ge,u as ee,r as f,G as me,H as Ee,J as re,K as Ce,L as ys,M as ke,N as ye,O as fs,P as he,m as e,B as z,o as Pe,R as ce,D as fe,p as ie,q as xs,s as Rs,n as hs,t as As}from"./index-BDI7IlMk.js";import{L as ae,F as te,f as Le,a as Ue,b as Me,c as Be,d as Fe,e as Ae,g as v,S as Se,h as Ge,s as Gs,i as _s,C as $e,j as We,u as Te,Q as Ss,k as Ne,l as Ts,m as Ns,B as Ve,n as vs,o as Os,p as js,M as xe}from"./Options-D0MXAH3M.js";import{A as Is}from"./AutoSuggestAnswers-Cshp9Fvc.js";import"./lib-CGQHTf8E.js";const _e={topId:"",parentId:"null",id:"generateId",groupTitle:"",title:"",source:0,status:0,included:!1},Ke={topId:"null",parentId:"null",id:"define at BackEnd",kind:0,title:"",link:"",header:"",level:0,variations:[],hasSubGroups:!1,groupRows:[],answerRows:[],numOfAnswers:0,hasMoreAnswers:!1,isExpanded:!1,doc1:""},bs=(s,l)=>{console.log("------------------------------->"),console.log("----------------------- GroupReducer >",l.type),console.log("------------------------------->");const{groupRow:d}=l.payload;if(l.type===n.SET_FROM_LOCAL_STORAGE){const{keyExpanded:w}=l.payload;return{...s,keyExpanded:w}}let t=d?!gs.includes(l.type):!1;const{topRows:o}=s,u=ms.includes(l.type)?{...s}:Ds(s,l);if(t&&d){let w;const{topId:y,id:G}=d;if(G===y)w=o.map(a=>a.id===y?new X(d).groupRow:new X(a).groupRow);else{const a=o.find(A=>A.id===y);X.idToSet=G,X.newGroupRow=d;const R=new X(a).groupRow;w=o.map(A=>A.id===y?R:new X(A).groupRow),X.idToSet=""}u.topRows=w}if(Es.includes(l.type)){const{keyExpanded:w}=u,y={keyExpanded:w};localStorage.setItem("GROUPS_STATE",JSON.stringify(y))}return console.log("GroupReducer newState",u),u},Ds=(s,l)=>{switch(l.type){case n.SET_TOP_ROWS_LOADING:return{...s,loadingGroups:!0,topRowsLoading:!0};case n.SET_TOP_ROWS:{const{topRows:t}=l.payload;return console.log("=> GroupsReducer ActionTypes.SET_TOP_ROWS",s.topRows,t),{...s,topRows:t,topRowsLoading:!1,topRowsLoaded:!0,loadingGroups:!1}}case n.SET_ALL_GROUP_ROWS:{const{allGroupRows:t}=l.payload;return{...s,allGroupRows:t,allGroupRowsLoaded:Date.now()}}case n.SET_NODE_EXPANDING_UP_THE_TREE:{const{fromChatBotDlg:t}=l.payload,{keyExpanded:o,activeGroup:u,activeAnswer:w}=s;return{...s,nodeOpening:!0,loadingGroups:!0,nodeOpened:!1,keyExpanded:t?null:{...o},activeGroup:t?null:u,activeAnswer:t?null:w}}case n.SET_NODE_EXPANDED_UP_THE_TREE:{const{group:t,formMode:o,grpKey:u,answerId:w,answer:y}=l.payload,{id:G}=u;return{...s,activeGroup:t,activeAnswer:y,selectedAnswerId:w,formMode:o,groupId_answerId_done:`${G}_${w}`,nodeOpening:!1,nodeOpened:!0,loadingGroups:!1}}case n.SET_LOADING_GROUP:return{...s,loadingGroup:!0,groupLoaded:!1};case n.FORCE_GROUP_OPEN_NODE:const{keyExpanded:d}=l.payload;return{...s,topRows:s.topRows.filter(t=>t.parentId===null),keyExpanded:d,nodeOpened:!1,activeGroup:null,activeAnswer:null,selectedAnswerId:null};case n.SET_SUB_GROUPS:return{...s,loadingGroup:!1};case n.SET_GROUP_ERROR:{const{error:t,whichRowId:o}=l.payload;return{...s,error:t,whichRowId:o,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1}}case n.ADD_SUB_GROUP:{const{groupKey:t,level:o}=l.payload,{topId:u}=t,w={...Ke,topId:u,level:o,parentId:""};return{...s,activeGroup:w,formMode:E.AddingGroup}}case n.SET_GROUP:{const{groupRow:t}=l.payload;return console.assert(ge(t)),{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:t,activeAnswer:null,selectedAnswerId:null}}case n.SET_ROW_EXPANDING:return{...s,rowExpanding:!0,rowExpanded:!1,loadingGroups:!0};case n.SET_ROW_EXPANDED:{const{groupRow:t}=l.payload,{topId:o,id:u}=t,{keyExpanded:w}=s,y=w?w.answerId:null;return{...s,loadingGroups:!1,keyExpanded:{topId:o,groupId:u,answerId:y},activeAnswer:null,selectedAnswerId:y,loadingAnswer:!1,answerLoaded:!1,rowExpanding:!1,rowExpanded:!0}}case n.SET_ROW_COLLAPSED:{const{groupRow:t}=l.payload,{topId:o,parentId:u}=t;return{...s,loadingGroups:!1,keyExpanded:{topId:o,groupId:u??"",answerId:null},rowExpanding:!1,rowExpanded:!0,activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case n.SET_GROUP_TO_VIEW:{const{groupRow:t}=l.payload;console.assert(ge(t));const u={...t,isExpanded:!1};return{...s,formMode:E.ViewingGroup,loadingGroup:!1,activeGroup:u,activeAnswer:null,selectedAnswerId:null}}case n.SET_GROUP_TO_ADD_TOP:{const{newGroupRow:t}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...t,doc1:""},activeAnswer:null,selectedAnswerId:null,topRows:[t,...s.topRows],formMode:E.AddingGroup}}case n.SET_GROUP_TO_ADD:{const{newGroupRow:t}=l.payload;return{...s,loadingGroup:!1,groupLoaded:!0,activeGroup:{...t,doc1:""},activeAnswer:null,selectedAnswerId:null,formMode:E.AddingGroup}}case n.SET_GROUP_ADDED:{const{groupRow:t}=l.payload;console.assert(ge(t));const u={...t,isExpanded:!1},{topId:w,id:y}=u;return{...s,formMode:E.EditingGroup,loadingGroup:!1,groupLoaded:!1,activeGroup:u,activeAnswer:null,selectedAnswerId:null,keyExpanded:{topId:w,groupId:y,answerId:null},nodeOpened:!1}}case n.SET_GROUP_TO_EDIT:case n.SET_GROUP_UPDATED:{const{groupRow:t,group:o}=l.payload;console.assert(ge(t));const{topId:u,id:w}=o;return{...s,formMode:E.EditingGroup,loadingGroup:!1,groupLoaded:!0,keyExpanded:{topId:u,groupId:w,answerId:null},activeGroup:o,activeAnswer:null,selectedAnswerId:null}}case n.SET_ANSWERS_LOADING:return{...s,loadingAnswers:!0,answerLoaded:!1};case n.GROUP_ANSWERS_LOADED:return{...s,loadingAnswers:!1};case n.DELETE_GROUP:return{...s,activeGroup:null,formMode:E.None,error:void 0,whichRowId:void 0};case n.CANCEL_GROUP_FORM:case n.CLOSE_GROUP_FORM:return{...s,activeGroup:null,formMode:E.None};case n.CANCEL_ADD_SUB_GROUP:return{...s,activeGroup:null,activeAnswer:null,selectedAnswerId:null,formMode:E.None};case n.SET_LOADING_ANSWER:return{...s,loadingAnswer:!0,answerLoaded:!1};case n.CANCEL_ADD_ANSWER:return{...s,formMode:E.None,activeAnswer:null,selectedAnswerId:null};case n.SET_ANSWER_SELECTED:{const{answerKey:t}=l.payload,{topId:o,parentId:u,id:w}=t;return{...s,topRows:s.topRows.filter(y=>y.parentId===null),keyExpanded:{topId:o,groupId:u,answerId:w},nodeOpened:!1,activeGroup:null,activeAnswer:null,selectedAnswerId:null}}case n.ADD_NEW_ANSWER_TO_ROW:{const{newAnswerRow:t}=l.payload;return{...s,selectedAnswerId:t.id}}case n.SET_ANSWER:{const{answer:t,formMode:o}=l.payload;return console.log(n.SET_ANSWER,t),{...s,activeGroup:null,activeAnswer:t,formMode:o,error:void 0,loadingGroup:!1,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_AFTER_ASSIGN_ANSWER:{const{answer:t}=l.payload;return{...s,activeAnswer:t,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_TO_VIEW:{const{answer:t}=l.payload,{keyExpanded:o}=s;return{...s,formMode:E.ViewingAnswer,keyExpanded:o,activeAnswer:t,loadingAnswer:!1,answerLoaded:!0}}case n.SET_ANSWER_TO_EDIT:{const{answer:t}=l.payload,{topId:o,id:u,parentId:w}=t;return{...s,keyExpanded:{topId:o,groupId:w,answerId:u},activeAnswer:t,formMode:E.EditingAnswer,selectedAnswerId:t.id,loadingAnswer:!1,answerLoaded:!0}}case n.ANSWER_DELETED:return{...s,activeAnswer:null,selectedAnswerId:null,formMode:E.None,loadingAnswer:!1,answerLoaded:!0};case n.CANCEL_ANSWER_FORM:case n.CLOSE_ANSWER_FORM:return{...s,formMode:E.None,activeAnswer:null,selectedAnswerId:null};default:return alert(`Action ${l.type} not allowed`),{...s}}};class X{static idToSet;static newGroupRow;constructor(l){const{topId:d,id:t,parentId:o,title:u,link:w,kind:y,header:G,level:a,variations:R,numOfAnswers:A,hasSubGroups:j,groupRows:N,created:P,modified:I,answerRows:B,isExpanded:_}=l,O=N.map(F=>(console.log("DeepClone >>>>>>>>>>>>>>>",F.id),F.id===X.idToSet?{...X.newGroupRow}:new X(F).groupRow));this.groupRow={topId:d,parentId:o,id:t,kind:y,title:u,link:w,header:G,level:a,hasSubGroups:j,groupRows:O,numOfAnswers:A,answerRows:B,variations:R??[],created:P,modified:I,isExpanded:_}}groupRow}const ze=f.createContext({}),He=f.createContext(()=>null),Cs={formMode:E.None,allGroupRows:new Map,allGroupRowsLoaded:void 0,topRows:[],topRowsLoading:!1,topRowsLoaded:!1,nodeOpening:!1,nodeOpened:!1,keyExpanded:null,groupId_answerId_done:void 0,activeGroup:null,activeAnswer:null,selectedAnswerId:null,loadingGroups:!1,loadingAnswers:!1,loadingGroup:!1,groupLoaded:!1,loadingAnswer:!1,answerLoaded:!1,error:void 0,rowExpanding:!1,rowExpanded:!1},ks=({children:s})=>{const l=ee(),{KnowledgeAPI:d,isAuthenticated:t,workspace:o,authUser:u,canEdit:w}=l,{nickName:y}=u,[G,a]=f.useReducer(bs,Cs),{formMode:R,activeGroup:A,activeAnswer:j,keyExpanded:N,topRows:P,allGroupRows:I,allGroupRowsLoaded:B}=G;console.log("----->>> ----->>> ----->>> GroupProvider"),f.useEffect(()=>{let i=o==="SLINDZA"?{topId:"MTS",groupId:"MTS",answerId:"aaaaaa111"}:{topId:"MTS",groupId:"REMOTECTRLS",answerId:"aaaaaa111"};if("localStorage"in window){let r=localStorage.getItem("GROUPS_STATE");if(console.log("GROUPS_STATE loaded before signIn",r),r!==null){const g=JSON.parse(r);g.keyExpanded!==null&&(i=g.keyExpanded)}}a({type:n.SET_FROM_LOCAL_STORAGE,payload:{keyExpanded:i}})},[o]);const _=f.useCallback(async(i,r,g=null,c=void 0)=>{const p=localStorage.getItem("accessToken");if(p)try{console.log("------Execute endpoint:",r);let m=null;const h=new Headers,T=`Bearer ${p}`;h.append("Authorization",T),g&&h.append("Content-Type","application/json");let D={method:i,headers:h,body:g?JSON.stringify(g):null};if(m=await fetch(r,D),m.ok){if(m.status===200||m.status===201){let $=null;try{$=await m.json()}catch{a({type:n.SET_GROUP_ERROR,payload:{error:new Error(`Response status: ${m.status}`),whichRowId:c}})}finally{return $}}}else{const{errors:$}=await m.json(),Q=new Error($?.map(J=>J.message).join(`
`)??"unknown");a({type:n.SET_GROUP_ERROR,payload:{error:Q,whichRowId:c}})}}catch(m){console.log("-------------->>> execute",i,r,m),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("fetch eror"),whichRowId:c}})}return null},[]),O=f.useCallback(async()=>new Promise(async i=>{try{console.time();const r=`${d.endpointGroupRow}/${o}`;await _("GET",r,null).then(g=>{const c=new Map;console.timeEnd(),g.forEach(p=>c.set(p.Id,new me(p).groupRow)),c.forEach(p=>{let{id:m,parentId:h}=p,T=m,D=h;for(;D;){const $=c.get(D);T=$.id+" / "+T,D=$.parentId}p.titlesUpTheTree=T,c.set(m,p)}),a({type:n.SET_ALL_GROUP_ROWS,payload:{allGroupRows:c}}),i(!0)})}catch(r){console.log(r),a({type:n.SET_GROUP_ERROR,payload:{error:r}})}i(!0)}),[_,d.endpointGroupRow,o]),F=f.useCallback(async i=>{try{return I.get(i)}catch(r){console.log(r),a({type:n.SET_GROUP_ERROR,payload:{error:r}})}},[I]);f.useEffect(()=>{(async()=>B===void 0&&await O())()},[B,O]);const W=f.useCallback(async i=>{try{let r="";const g=[];return I.forEach((c,p)=>{p===i?r="":c.parentId===i&&g.push(c)}),{subCats:g,parentHeader:r}}catch(r){return console.log(r),a({type:n.SET_GROUP_ERROR,payload:{error:r}}),{subCats:[],parentHeader:"Kiks subCats"}}},[I]),S=f.useCallback(async()=>new Promise(async i=>{try{a({type:n.SET_TOP_ROWS_LOADING,payload:{}});const r=`${d.endpointGroupRow}/${o}/null/topRows/all`;console.log("GroupProvider loadTopRows url:",r),console.log("loadTopRows AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"),console.time(),await _("GET",r).then(g=>{console.timeEnd(),console.log("loadTopRows BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");const c=g.map(p=>(p.IsExpanded=N?p.Id===N.groupId:!1,new me(p).groupRow));a({type:n.SET_TOP_ROWS,payload:{topRows:c}}),i(!0)})}catch(r){console.log(r),a({type:n.SET_GROUP_ERROR,payload:{error:r}})}}),[_,d.endpointGroupRow,N,o]),b=f.useCallback(async(i,r)=>{const{topId:g,id:c}=i;return console.log({groupKey:i,includeAnswerId:r}),new Promise(async p=>{try{const m=`${d.endpointGroup}/${o}/${g}/${c}/${pe}/${r}`;console.time(),console.log("================ getGroup ======================="),await _("GET",m).then(h=>{console.timeEnd();const{groupDto:T,msg:D}=h;p(T?new Ee(T).group:new Error(D))})}catch(m){console.log(m),p(m)}})},[_,d.endpointGroup,o]),C=f.useCallback((i,r)=>{if(i.topId===r)return i;const{groupRows:g}=i;let c=g.find(p=>p.id===(r??"null"));if(!c)try{g.forEach(p=>{if(console.log(r,p.id),c=C(p,r),c)throw new Error("Stop the loop")})}catch{}return c},[]),V=f.useCallback(async(i,r,g="false")=>new Promise(async()=>{try{let{topId:c,parentId:p,id:m}=i;if(console.assert(m!==null,"id ne sme biti null u expandNodesUpToTheTree"),m){const $=I.get(m);$?(i.topId=$.topId,i.parentId=$.parentId):alert("reload all groupRow:"+m)}a({type:n.SET_NODE_EXPANDING_UP_THE_TREE,payload:{fromChatBotDlg:g==="true"}}),console.time();const h={topId:c,id:m,parentId:null},T=new re(h).toQuery(o),D=`${d.endpointGroupRow}?${T}&pageSize=${pe}&includeAnswerId=${r??null}`;await _("GET",D).then(async $=>{const{groupRowDto:Q}=$;if(console.timeEnd(),Q){let J=null,de=null,oe=new me(Q).groupRow;if(p!==null){const we=C(oe,m);if(J={...we,doc1:""},r){const be=we.answerRows.find(De=>De.id===r&&De.included);be&&(J=null,de={...be,source:0,status:0})}}console.log(">>> expandNodeUpToTheTree groupRow",{groupRow:oe,answerId:"'"+(r??"jok")+"'"+(r??"JOK")});const Re=r?w?E.EditingAnswer:E.ViewingAnswer:w?E.EditingGroup:E.ViewingGroup;a({type:n.SET_NODE_EXPANDED_UP_THE_TREE,payload:{grpKey:i,groupRow:oe,group:J,answerId:r??null,answer:de,formMode:Re,fromChatBotDlg:g==="true"}})}})}catch(c){console.log(c),a({type:n.SET_GROUP_ERROR,payload:{error:c}})}}),[o,d.endpointGroupRow,_,I,C,w]),x=f.useCallback(async(i,r=!1,g=null)=>{const c=new re(i).toQuery(o);return new Promise(async p=>{try{const m=`${d.endpointGroupRow}/${r}/${pe}/${g}?${c}`;console.time(),await _("GET",m).then(h=>{console.timeEnd();const{groupRowDto:T,msg:D}=h;p(T?new me(T).groupRow:new Error(D))})}catch(m){console.log(m),p(m)}})},[_,d.endpointGroupRow,o]),k=f.useCallback(async({groupKey:i,includeAnswerId:r,newAnswerRow:g,formMode:c})=>{try{a({type:n.SET_ROW_EXPANDING,payload:{}});const p=await x(i,!0,r);if(p instanceof Error)a({type:n.SET_GROUP_ERROR,payload:{error:p}}),console.error({cat:p});else{let m;return r&&p.answerRows.filter(h=>h.included).length>0&&(m=r),g&&(p.answerRows=[g,...p.answerRows]),p.isExpanded=!0,console.log("@@@@@@@@@@@@@@@@@ expandGroup:",c,r),c===E.None&&r&&(c=w?E.EditingAnswer:E.ViewingAnswer),a({type:n.SET_ROW_EXPANDED,payload:{groupRow:p,formMode:c,selectedAnswerId:m}}),p}}catch(p){return console.log("error",p),a({type:n.SET_GROUP_ERROR,payload:{error:p}}),null}},[w,x]),se=f.useCallback(async i=>{const{topId:r,id:g}=i,c=P.find(m=>m.id===r);i={...c.id===g?c:C(c,g),isExpanded:!1,groupRows:[],answerRows:[]},a({type:n.SET_ROW_COLLAPSED,payload:{groupRow:i}})},[C,P]),U=f.useCallback(async i=>{try{a({type:n.CLOSE_GROUP_FORM,payload:{}});const{topId:r,id:g,parentId:c,level:p}=i??{topId:"generateId",id:"generateId",parentId:null,level:0},m={...Ke,topId:r,parentId:i?g:c,id:"generateId",level:p+1,title:"",isExpanded:!1};if(i===null)a({type:n.SET_GROUP_TO_ADD_TOP,payload:{newGroupRow:m}});else{const h={...i,level:p+1,groupRows:[m,...i.groupRows],hasSubGroups:!0,isExpanded:!0};a({type:n.SET_GROUP_TO_ADD,payload:{groupRow:h,newGroupRow:m}})}}catch(r){console.log("error",r),a({type:n.SET_GROUP_ERROR,payload:{error:r}})}},[]),M=f.useCallback(async()=>{try{const{topId:i,id:r,parentId:g}=A,p={groupKey:{topId:i,parentId:g,id:r},formMode:E.None},m=await k(p);m&&a({type:n.CANCEL_ADD_SUB_GROUP,payload:{groupRow:m}})}catch(i){console.log("error",i),a({type:n.SET_GROUP_ERROR,payload:{error:i}})}},[A,k]),Y=f.useCallback(async i=>{const{id:r}=i;a({type:n.SET_LOADING_GROUP,payload:{}});try{const g=new Ce(i,o).groupDto;console.log("groupDto",{groupDto:g});const c=`${d.endpointGroup}`;console.time(),await _("POST",c,g,r).then(async p=>{console.timeEnd();const{groupDto:m}=p;if(m){const h=new Ee(m).group;console.log("Group successfully created",{group:h}),await O().then(async()=>{await S(),h.parentId===null?a({type:n.SET_GROUP_ADDED,payload:{groupRow:h}}):a({type:n.SET_GROUP_ADDED,payload:{groupRow:h}})})}})}catch(g){console.log(g),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:r}})}},[_,d.endpointGroup,O,S,o]),L=f.useCallback(async()=>{try{const{topId:i,parentId:r}=j,c={groupKey:{topId:i,parentId:r,id:r},formMode:E.None},p=await k(c);p&&a({type:n.CANCEL_ADD_ANSWER,payload:{groupRow:p}})}catch(i){console.log("error",i),a({type:n.SET_GROUP_ERROR,payload:{error:i}})}},[j,k]),H=f.useCallback(async(i,r)=>{R===E.AddingAnswer?await L():R===E.AddingGroup&&await M(),a({type:n.SET_LOADING_GROUP,payload:{groupRow:i}});const g=new re(i).groupKey,c=await b(g,r);c instanceof Error?a({type:n.SET_GROUP_ERROR,payload:{error:c}}):(c.topId=i.topId,a({type:n.SET_GROUP_TO_VIEW,payload:{groupRow:c}}))},[M,L,R,b]),ne=f.useCallback(async(i,r)=>{R===E.AddingAnswer?await L():R===E.AddingGroup&&await M(),a({type:n.SET_LOADING_GROUP,payload:{}});const g=new re(i).groupKey,c=await b(g,r);if(c instanceof Error)a({type:n.SET_GROUP_ERROR,payload:{error:c}});else{const p={...c,isExpanded:!1,groupRows:[],answerRows:[]};a({type:n.SET_GROUP_TO_EDIT,payload:{groupRow:p,group:c}})}},[M,L,R,b]),q=f.useCallback(async i=>{a({type:n.SET_LOADING_GROUP,payload:{}});try{const r=new Ce(i,o).groupDto,g=`${d.endpointGroup}`;console.time(),await _("PUT",g,r).then(c=>{console.timeEnd();const{groupDto:p,msg:m}=c;if(p){const h=new Ee(p).group,{topId:T}=h;h.isExpanded=!1,h.topId=T,a({type:n.SET_GROUP_UPDATED,payload:{group:h}})}else a({type:n.SET_GROUP_ERROR,payload:{error:new Error(`${m}`)}})})}catch(r){return console.log(r),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Karambol")}}),r}},[_,d.endpointGroup,o]),le=f.useCallback(async i=>{try{const{topId:r,parentId:g}=i,c=new ys(i,o).groupRowDto,p=`${d.endpointGroup}`;console.time(),await _("DELETE",p,c).then(async m=>{console.timeEnd();const{groupDto:h,msg:T}=m;T==="OK"?(console.log("Group successfully deleted",{groupRow:i}),await O().then(async()=>{const D={groupKey:{topId:r,parentId:"",id:g},formMode:E.None};g?await S():await k(D).then(()=>{})})):a(T==="HasSubGroups"?{type:n.SET_GROUP_ERROR,payload:{error:new Error("First remove sub groups"),whichRowId:h.Id}}:T==="HasAnswers"?{type:n.SET_GROUP_ERROR,payload:{error:new Error("First remove group answers"),whichRowId:h.Id}}:{type:n.SET_GROUP_ERROR,payload:{error:new Error(T),whichRowId:h.Id}})})}catch(r){return console.log(r),r}},[_,d.endpointGroup,k,O,S,o]),os=async(i,r)=>{try{console.log("Deleting Group Tag...",{groupKey:i,variationName:r}),console.log("Group Tag successfully deleted")}catch(g){console.log("error",g),a({type:n.SET_GROUP_ERROR,payload:{error:g}})}},pe=12,rs=f.useCallback(async({groupKey:i,startCursor:r,includeAnswerId:g})=>{try{const{topId:c,id:p}=i;a({type:n.SET_ANSWERS_LOADING,payload:{}});try{const m=`${d.endpointAnswer}/${o}/${c}/${p}/${r}/${pe}/${g}`;console.time(),await _("GET",m).then(h=>{console.timeEnd();const{groupDto:T}=h;if(T!==null){const D=new Ee(T).group;a({type:n.GROUP_ANSWERS_LOADED,payload:{groupRow:D}})}})}catch(m){console.log(m),a({type:n.SET_GROUP_ERROR,payload:{error:m}})}}catch(c){console.log(c),a({type:n.SET_GROUP_ERROR,payload:c})}},[_,d.endpointAnswer,o]),ts=f.useCallback(async(i,r)=>{try{const{topId:g,id:c}=i;let p=await F(c);if(!p){alert(`Not found ${c}. Reload all Groups`);return}const m={topId:g,parentId:i.id,id:"generateId",title:"answer text",groupTitle:p.title,included:!0},h={..._e,...m,title:""};if(console.assert(r),r){const T=G.topRows.find($=>$.id===g),D=C(T,c);D.answerRows=[m,...D.answerRows],a({type:n.ADD_NEW_ANSWER_TO_ROW,payload:{groupRow:D,newAnswerRow:m}}),a({type:n.SET_ANSWER,payload:{answer:h,formMode:E.AddingAnswer}})}}catch(g){console.log("error",g),a({type:n.SET_GROUP_ERROR,payload:{error:g}})}},[k,C,F,G.topRows]),as=f.useCallback(async i=>{const{topId:r,id:g,parentId:c}=i;a({type:n.SET_LOADING_GROUP,payload:{}});try{i.created.nickName=y;const p=new ke(i,o).answerDto,m=`${d.endpointAnswer}`;console.time(),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> createAnswer",p),await _("POST",m,p).then(async h=>{if(console.timeEnd(),h){console.log("::::::::::::::::::::",{answerDtoEx:h});const{answerDto:T}=h;if(T){const D=new ye(T).answer;D.topId=r,console.log("Answer successfully created"),await O().then(async()=>{const Q={groupKey:{topId:r,parentId:c,id:c},formMode:E.EditingAnswer};await k(Q).then(()=>{a({type:n.SET_ANSWER,payload:{formMode:E.EditingAnswer,answer:D}})})})}}})}catch(p){console.log(p),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[_,d.endpointAnswer,k,O,y,o]),ls=f.useCallback(async(i,r,g)=>{const{id:c}=r;try{r.modified.nickName=y;const p=new ke(r,o).answerDto,m=`${d.endpointAnswer}`;console.time(),p.oldParentId=i,console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> updateAnswer",p);let h=null;return await _("PUT",m,p).then(async T=>{console.timeEnd();const{answerDto:D,msg:$}=T;if(D){h=new ye(D).answer,console.log("Answer successfully updated: ",h);const{topId:Q,parentId:J}=h;if(g){const{topId:de,parentId:oe,id:Re}=h,we={topId:de,groupId:oe,answerId:Re};a({type:n.FORCE_GROUP_OPEN_NODE,payload:{keyExpanded:we}})}else{const oe={groupKey:{topId:Q,parentId:J,id:J},formMode:E.EditingAnswer};await k(oe).then(()=>{a({type:n.SET_ANSWER,payload:{formMode:E.EditingAnswer,answer:h}})})}}else a({type:n.SET_GROUP_ERROR,payload:{error:new Error($)}})}),h}catch(p){console.log(p),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:c}})}},[_,d.endpointAnswer,k,y,o]),ds=f.useCallback(async(i,r)=>{const{id:g,parentId:c,topId:p}=i;a({type:n.SET_LOADING_ANSWER,payload:{}});try{const m=new fs(i,o).answerRowDto,h=`${d.endpointAnswer}`;console.time(),await _("DELETE",h,m).then(async T=>{const{answerDto:D}=T;if(console.timeEnd(),D){const $=new ye(D).answer;console.log("Answer successfully deleted"),r&&a({type:n.ANSWER_DELETED,payload:{answer:$}});const J={groupKey:{topId:p,parentId:c,id:c},formMode:E.None};await k(J).then(()=>{})}else console.error(T),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})})}catch(m){console.log(m),a({type:n.SET_GROUP_ERROR,payload:{error:new Error("Server Error"),whichRowId:g}})}},[_,d.endpointAnswer,k,o]),ue=f.useCallback(async i=>new Promise(async r=>{try{const g=new he(i).toQuery(o),c=`${d.endpointAnswer}?${g}`;console.time(),console.log("getAnswer",i),await _("GET",c).then(p=>{console.timeEnd();const{answerDto:m,msg:h}=p;if(m){const T={answer:new ye(m).answer,msg:h};r(T)}else r({answer:null,msg:h})})}catch(g){console.log(g),r({answer:null,msg:"Problemos"})}}),[_,d.endpointAnswer,o]),is=f.useCallback(async i=>{const r=new he(i).answerKey;a({type:n.SET_LOADING_ANSWER,payload:{}});const g=await ue(r);R===E.AddingAnswer?await L():R===E.AddingGroup&&await M();const{answer:c,msg:p}=g;c?(c.topId=i.topId,a({type:n.SET_ANSWER_TO_VIEW,payload:{answer:c}})):a({type:n.SET_GROUP_ERROR,payload:{error:new Error(p)}})},[M,L,R,ue]),cs=f.useCallback(async i=>{const r=new he(i).answerKey;R===E.AddingAnswer?await L():R===E.AddingGroup&&await M(),a({type:n.SET_LOADING_ANSWER,payload:{}}),console.log("editAnswer:",r);const g=await ue(r),{answer:c,msg:p}=g;c?(c.topId=i.topId,a({type:n.CLOSE_ANSWER_FORM,payload:{answer:c}}),a({type:n.SET_ANSWER_TO_EDIT,payload:{answer:c}})):a({type:n.SET_GROUP_ERROR,payload:{error:new Error(p)}})},[M,L,R,ue]),ps=f.useCallback((i,r)=>{console.log("Provider onGroupTitleChanged:",r),a({type:n.GROUP_TITLE_CHANGED,payload:{groupRow:{...i,title:r}}})},[]),us=f.useCallback((i,r,g)=>{const{parentId:c,id:p}=r,m=C(i,c);if(m){const h=m.answerRows.find(T=>T.id===p);h.title=g,console.log("onAnswerTitleChanged+++>>>",p,m),a({type:n.ANSWER_TITLE_CHANGED,payload:{groupRow:m}})}},[C]),ws={state:G,loadAllGroupRows:O,getSubGrps:W,getGrp:F,expandNodesUpToTheTree:V,loadTopRows:S,addSubGroup:U,cancelAddGroup:M,createGroup:Y,viewGroup:H,editGroup:ne,updateGroup:q,deleteGroup:le,deleteGroupVariation:os,expandGroup:k,collapseGroup:se,onGroupTitleChanged:ps,loadGroupAnswers:rs,addAnswer:ts,cancelAddAnswer:L,createAnswer:as,viewAnswer:is,editAnswer:cs,updateAnswer:ls,deleteAnswer:ds,onAnswerTitleChanged:us};return!t||!B||N===null?null:e.jsx(ze.Provider,{value:ws,children:e.jsx(He.Provider,{value:a,children:s})})};function K(){return f.useContext(ze)}const ve=()=>f.useContext(He),Ps="/knowledge/assets/APlus-sw4jpCsS.png";var Z=(s=>(s.SET_LOADING="SET_LOADING",s.SET_SUB_CATS="SET_SUB_CATS",s.SET_ERROR="SET_ERROR",s.SET_EXPANDED="SET_EXPANDED",s.SET_PARENT_CAT="SET_PARENT_CAT",s))(Z||{});const Ls=({cat:s,dispatch:l,setParentGrp:d,selId:t})=>{const{topId:o,parentId:u,id:w,title:y,level:G,isExpanded:a}=s,R={topId:o,parentId:u,id:w},A=P=>{l({type:Z.SET_EXPANDED,payload:{id:w,expanding:!a}})},j=P=>{d(P)},N=e.jsxs("div",{className:"d-flex justify-content-start align-items-center w-100 text-primary",children:[e.jsx(z,{variant:"link",size:"sm",className:"py-0 px-1",onClick:P=>{A(),P.stopPropagation(),P.preventDefault()},title:"Expand",children:e.jsx(te,{icon:a?Le:Ue,size:"lg"})}),e.jsx(z,{variant:"link",size:"sm",className:"py-0 mx-0 text-decoration-none",title:w,onClick:()=>j(s),children:y})]});return e.jsxs(e.Fragment,{children:[e.jsx(ae.Item,{variant:"primary",className:"py-0 px-1 w-100",as:"li",children:N}),a&&e.jsx(ae.Item,{className:"py-0 px-0",variant:"primary",as:"li",children:e.jsx(Xe,{selId:t,level:G+1,groupKey:R,setParentId:d})})]})},Us={loading:!1,parentId:null,title:"",cats:[]},Ms=(s,l)=>{switch(l.type){case Z.SET_LOADING:return{...s,loading:!0};case Z.SET_SUB_CATS:{const{subGrps:d}=l.payload;return{...s,cats:s.cats.concat(d),loading:!1}}case Z.SET_ERROR:{const{error:d}=l.payload;return{...s,error:d,loading:!1}}case Z.SET_EXPANDED:{const{id:d,expanding:t}=l.payload;let{cats:o}=s;if(!t){const u=qe(o,d);console.log("clean:",u),u.length>0&&(o=o.filter(w=>!u.includes(w.id)))}return{...s,cats:s.cats.map(u=>u.id===d?{...u,isExpanded:t}:u)}}case Z.SET_PARENT_CAT:{const{cat:d}=l.payload,{id:t,title:o}=d;return{...s,parentId:t,title:o}}default:return s}};function qe(s,l){let d=s.filter(t=>t.parentId===l).map(t=>t.id);return d.forEach(t=>{const o=t?qe(s,t):[];d=d.concat(o)}),d}const Xe=({selId:s,groupKey:l,level:d,setParentId:t})=>{const[o,u]=f.useReducer(Ms,Us),{getSubGrps:w}=K(),{id:y}=l??{id:null},[G]=f.useState(l);f.useEffect(()=>{(async()=>{const A=await w(y),{subGrps:j}=A;u({type:Z.SET_SUB_CATS,payload:{subGrps:j}})})()},[w,G,y]);const a=o.cats.filter(A=>A.parentId===y),R=A=>{u({type:Z.SET_PARENT_CAT,payload:{cat:A}}),t(A)};return e.jsxs("div",{className:d>1?"border  border-7 ms-4 h-25":"border border-7  h-25",style:{overflowY:"auto"},children:[e.jsx(ae,{as:"ul",variant:"dark",className:"mb-0",children:a.filter(A=>A.id!==s).map(A=>e.jsx(Ls,{cat:A,selId:s,dispatch:u,setParentGrp:R},A.id))}),o.error&&o.error.message]})},Oe=({answer:s,submitForm:l,children:d,showCloseButton:t,source:o=0,closeModal:u})=>{const{state:w,onAnswerTitleChanged:y}=K();let{formMode:G,topRows:a}=w;const R=G===E.ViewingAnswer,A=G===E.EditingAnswer,j=G===E.AddingAnswer,N=R,{topId:P,id:I,title:B}=s,_=ve(),O=()=>{u?u():_({type:n.CLOSE_ANSWER_FORM,payload:{answer:s}})},F=()=>{u?u():_({type:n.CANCEL_ANSWER_FORM,payload:{answer:s}})},[W,S]=f.useState(I+"/"+B),b=Me(W,500),[C]=f.useState(a.find(U=>U.id===P)),V=f.useRef(null),x=Be({enableReinitialize:!0,initialValues:s,validationSchema:Fe().shape({title:Ae().required("Required"),parentId:Ae().required("Required").notOneOf(["000000000000000000000000"])}),onSubmit:U=>{l(U),S(U.id+"/"+U.title)}});f.useEffect(()=>{(async()=>{const M=b.split("/"),Y=M[0];if(x.values.id===Y){console.log("AnswerForm.useEffect - onQuestioTitleChanged",{debouncedSearchTerm:b,searchTerm:W,title:x.values.title});const L=M[1];await y(C,x.values,L)}})()},[b,x.values,y,W,C]),f.useEffect(()=>{V.current.focus(),o!==0&&x.setFieldValue("source",o)},[x,V,o]);const k=U=>{x.handleChange(U);const M=U.target.value;S(I+"/"+M)},se=U=>{x.setFieldValue("parentId",U.id),x.setFieldValue("groupTitle",U.title)};return console.log("@@@@@@@@@@@@@@@@@@@@@ AnswerForm.render: ",{searchTerm:W,qTitle:B,debouncedSearchTerm:b}),e.jsxs("div",{className:"form-wrapper px-3 py-1 my-0 my-1 w-100 answer-form",children:[t&&e.jsx(Pe,{onClick:O,className:"float-end"}),e.jsx(ce,{className:"text-center",children:e.jsxs(v.Label,{children:["Answer  ",R?"Viewing":A?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:x.handleSubmit,children:[e.jsxs(Se,{direction:"horizontal",gap:0,className:"border",children:[e.jsx("div",{className:"p-0",children:e.jsx(v.Label,{children:"Group:"})}),e.jsx("div",{className:"p-1",children:e.jsxs(v.Group,{controlId:"parentId",className:"group-select form-select-sm w-90",children:[e.jsxs(fe,{children:[e.jsx(fe.Toggle,{variant:"light",id:"dropdown-basic",className:"px-2 py-0 text-primary border",disabled:N,children:e.jsx("span",{className:"text-wrap me-1",children:x.values.groupTitle})}),e.jsx(fe.Menu,{className:"p-0 border",children:e.jsx(fe.Item,{className:"p-0 m-0 rounded-3",children:e.jsx(Xe,{selId:x.values.parentId,groupKey:null,level:1,setParentId:se})})})]}),e.jsx(v.Control,{as:"input",name:"parentId",onChange:x.handleChange,value:x.values.parentId?x.values.parentId:"",placeholder:"Group",className:"text-primary w-100",disabled:N,hidden:!0}),e.jsx(v.Text,{className:"text-danger",children:x.touched.parentId&&x.errors.parentId?e.jsx("div",{className:"text-danger",children:x.errors.parentId?"required":""}):null})]})})]}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:x.values.title==="new Answer"?"new Answer":"answer text",ref:V,onChange:k,value:x.values.title,rows:3,className:"text-primary w-100",disabled:N}),e.jsx(v.Text,{className:"text-danger",children:x.touched.title&&x.errors.title?e.jsx("div",{className:"text-danger",children:x.errors.title}):null})]}),e.jsxs(ce,{children:[e.jsx(ie,{children:e.jsxs(v.Group,{controlId:"source",children:[e.jsx(v.Label,{children:"Source"}),e.jsx(Ge,{id:"source",name:"source",options:Gs,onChange:(U,M)=>{U.preventDefault(),x.setFieldValue("source",M)},value:x.values.source,disabled:N,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:x.touched.source&&x.errors.source?e.jsx("div",{className:"text-danger",children:x.errors.source}):null})]})}),e.jsx(ie,{children:e.jsxs(v.Group,{controlId:"status",children:[e.jsx(v.Label,{children:"Status"}),e.jsx(Ge,{id:"status",name:"status",options:_s,onChange:(U,M)=>{U.preventDefault(),x.setFieldValue("status",M)},value:x.values.status,disabled:N,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:x.touched.status&&x.errors.status?e.jsx("div",{className:"text-danger",children:x.errors.status}):null})]})})]}),(R||A)&&e.jsx("div",{className:"my-1",children:e.jsx($e,{created:s.created,modified:s.modified,classes:"text-primary"})}),(x.dirty&&A||j)&&e.jsx(We,{cancelForm:F,handleSubmit:x.handleSubmit,title:d}),w.error&&e.jsx("div",{className:"text-danger",children:w.error.message})]})]})},je=({closeModal:s,showCloseButton:l,source:d,setError:t})=>{const{state:o,cancelAddAnswer:u,createAnswer:w}=K(),{activeAnswer:y}=o,G=y?y.topId:"",a=async()=>{await u()},R=async A=>{const j={...A,topId:G,created:{time:new Date,nickName:""},modified:void 0},N=await w(j,s!==void 0);N&&(N.message?t(N.message):s&&s())};return y?e.jsx(Oe,{answer:y,showCloseButton:l??!0,source:d??0,closeModal:a,submitForm:R,children:"Create Answer"}):null},Qe=({})=>{const{state:s,updateAnswer:l}=K(),{activeAnswer:d}=s;if(!d)return null;if(!d)return e.jsx("div",{children:"Loading answer to edit..."});const t=async o=>{const u={...o,created:void 0,modified:{time:new Date,nickName:""}},{parentId:w}=d,y=w!==u.parentId;await l(w,u,y)};return e.jsx(Oe,{answer:d,showCloseButton:!0,source:0,submitForm:t,children:"Update Answer"})},Je=({inLine:s})=>{console.log(s?"ViewAnswer inLine":"ViewAnswer not inLine");const{state:l}=K(),{activeAnswer:d}=l,[t,o]=f.useState(null);return f.useEffect(()=>{console.log("#################################### ViewAnswer setAnswer ...",{activeAnswer:d}),o(d)},[d]),e.jsx(Oe,{answer:t,showCloseButton:!0,source:0,submitForm:()=>{},children:"View Answer"})},Bs=({answerRow:s,isSelected:l})=>{const{id:d,topId:t,parentId:o,title:u}=s,w={topId:t,parentId:o,id:o},{canEdit:y,authUser:G}=ee(),{state:a,viewAnswer:R,addAnswer:A,editAnswer:j,deleteAnswer:N}=K(),{activeAnswer:P,formMode:I,loadingAnswer:B,answerLoaded:_}=a,O=P!==null&&P.id===d,F=I===E.AddingAnswer,W=()=>{s.modified={time:new Date,nickName:G.nickName},N(s,O)},S=async x=>{console.log("AnswerRow onSelectAnswer",{id:x}),y?await j(s):await R(s)},[b,C]=Te();f.useEffect(()=>{(async()=>{if(l&&!B&&!_){switch(I){case E.ViewingAnswer:await R(s);break;case E.EditingAnswer:console.log("Zovem from AnswerRow"),y?await j(s):await R(s);break}document.getElementById(`AnswerRow${d}`)?.scrollIntoView({behavior:"smooth",block:"end"})}})()},[y,j,I,d,l,B,_,s,R]);const V=e.jsxs("div",{id:`AnswerRow${d}`,className:`d-relative d-flex justify-content-start align-items-center w-100 answer-row${l?"-selected":""}`,style:{marginTop:"0px"},children:[e.jsx(z,{variant:"link",size:"sm",className:"d-flex align-items-center px-1 text-secondary",children:e.jsx("img",{width:"22",height:"18",src:xs,alt:"Answer"})}),e.jsx(z,{variant:"link",size:"sm",className:`p-0 px-1 m-0 ms-0 answer-row-title ${O?"fw-bold":""}`,title:`id:${d.toString()}`,onClick:()=>S(d),disabled:F,children:u}),y&&!F&&C&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx(z,{variant:"link",size:"sm",className:"ms-1 p-0 text-secondary d-flex align-items-center",title:"Add Answer",onClick:()=>{A(w,!0)},children:e.jsx("img",{width:"22",height:"18",src:Ss,alt:"Add Answer"})}),e.jsx(z,{variant:"link",size:"sm",className:"ms-0 p-0 text-secondary",onClick:W,children:e.jsx(te,{icon:Ne,size:"lg"})})]})]});return e.jsxs(ae.Item,{className:"py-0 px-0 w-100",as:"li",children:[l&&I===E.AddingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(je,{showCloseButton:!0,source:0})}),e.jsx("div",{ref:b,className:"d-none d-md-block  border rounded-3",children:V})]}),l&&I===E.EditingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:b,className:"",children:V}),e.jsx("div",{id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(Qe,{inLine:!0})})]}),l&&I===E.ViewingAnswer&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:b,className:"",children:V}),e.jsx("div",{ref:b,id:"div-answer",className:"ms-0 d-md-none w-100",children:e.jsx(Je,{inLine:!0})})]}),!l&&e.jsx("div",{ref:b,className:"",children:V})]})},Ze=({groupRow:s})=>{const{state:l,loadGroupAnswers:d}=K(),{keyExpanded:t,loadingAnswer:o,error:u,selectedAnswerId:w}=l,{answerId:y}=t;s.level+=1;const{answerRows:G}=s;let a=!1;async function R(){try{const N={groupKey:new re(s).groupKey,startCursor:G.length,includeAnswerId:y??null};console.log("^^^^^^^^^^^^^ loadMore"),console.log("^^^^^^^^^^^^^",{x:N}),console.log("^^^^^^^^^^^^^ loadMore"),await d(N)}catch{}finally{}}const[A,{rootRef:j}]=Ts({loading:o,hasNextPage:a,onLoadMore:R,disabled:!!u,rootMargin:"0px 0px 100px 0px"});return e.jsxs("div",{ref:j,className:"ms-0",style:{maxHeight:"400px",overflowY:"auto"},children:[e.jsxs(Ns,{children:[G.length===0&&e.jsx("label",{children:"No answers"}),G.map(N=>e.jsx(Bs,{answerRow:N,isSelected:N.id===w},N.id)),a]}),u&&e.jsxs("p",{children:["Error: ",u.message]})]})},Fs=({groupKey:s,tag:l,groupInAdding:d})=>{const{name:t}=l,{canEdit:o}=ee(),{state:u,deleteGroupVariation:w}=K(),y=()=>{w(s,t)},[G,a]=Te(),R=e.jsxs("div",{ref:G,children:[e.jsx(Ve,{pill:!0,bg:"secondary",children:t}),o&&!0&&a&&e.jsx(z,{variant:"link",size:"sm",className:"ms-0 py-0 mx-0 text-secondary",onClick:y,children:e.jsx(te,{icon:Ne,size:"sm"})}),!1]});return e.jsx("div",{className:"py-1 px-1",children:R})},$s=({groupKey:s,variations:l})=>{const{state:d}=K(),{error:t}=d;return f.useEffect(()=>{},[]),e.jsxs("div",{className:"ms-2",children:[e.jsxs(Se,{direction:"horizontal",gap:2,children:[l.length===0&&e.jsx("div",{children:"No variations"}),l.length>0&&l.map(o=>e.jsx(Fs,{groupKey:s,tag:o,groupInAdding:void 0}))]}),t&&e.jsxs("p",{children:["Error: ",t.message]})]})},Ie=({formMode:s,group:l,submitForm:d,children:t})=>{const{onGroupTitleChanged:o}=K(),u=s===E.ViewingGroup,w=s===E.EditingGroup,y=s===E.AddingGroup,{topId:G,id:a,variations:R,answerRows:A,title:j}=l;console.log("GroupForm render: ",{topId:G,id:a,catTitle:j,formMode:s});const N=new re(l).groupKey;document.getElementById("div-details");const P=A&&A.length>0,I=ve(),B=()=>{I({type:n.CLOSE_GROUP_FORM,payload:{}})},_=()=>{I({type:n.CANCEL_GROUP_FORM,payload:{}})},[O,F]=f.useState(j),W=Me(O,300),S=Be({enableReinitialize:!0,initialValues:l,validationSchema:Fe().shape({title:Ae().required("Required")}),onSubmit:x=>{console.log("GroupForm.onSubmit",JSON.stringify(x,null,2)),d(x),F(x.title)}});f.useEffect(()=>{(async()=>{console.log("GroupForm.useEffect - onGroupTitleChanged",{debouncedSearchTerm:W,title:S.values.title}),await o(S.values,W)})()},[W,S.values,o]);const b=x=>{S.handleChange(x);const k=x.target.value;F(k)},C=f.useRef(null);f.useEffect(()=>{C.current.focus()},[l.title,C]);const V=!1;return console.log("GroupForm render return: ",O),e.jsxs("div",{className:"form-wrapper p-2 group-form",children:[e.jsx(Pe,{onClick:B,className:"float-end"}),e.jsx(ce,{className:"text-center text-muted",children:e.jsxs(v.Label,{children:["Group ",u?"Viewing":w?"Editing":"Adding"]})}),e.jsxs(v,{onSubmit:()=>S.handleSubmit,children:[e.jsx(v.Group,{controlId:"Variations",children:e.jsxs(Se,{direction:"horizontal",gap:1,children:[e.jsx("div",{className:"px-0",children:e.jsx(v.Label,{children:"Variations:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsx($s,{groupKey:N,variations:R?R.map(x=>({name:x})):[]})}),e.jsx("div",{className:"ps-2",children:e.jsx(v.Label,{children:"Kind:"})}),e.jsx("div",{className:"px-1 border border-1 border-secondary rounded",children:e.jsxs(v.Group,{controlId:"kind",children:[e.jsx(Ge,{id:"kind",name:"kind",options:vs,onChange:(x,k)=>{x.preventDefault(),S.setFieldValue("kind",k)},value:S.values.kind,disabled:V,classes:"text-primary"}),e.jsx(v.Text,{className:"text-danger",children:S.touched.kind&&S.errors.kind?e.jsx("div",{className:"text-danger",children:S.errors.kind}):null})]})})]})}),e.jsxs(v.Group,{controlId:"title",children:[e.jsx(v.Label,{children:"Title"}),e.jsx(v.Control,{as:"textarea",name:"title",placeholder:S.values.title==="new Group"?"new Group":"group text",value:O,onChange:b,ref:C,rows:3,className:"text-primary w-100",disabled:u}),e.jsx(v.Text,{className:"text-danger",children:S.touched.title&&S.errors.title?e.jsx("div",{className:"text-danger",children:S.errors.title}):null})]}),e.jsxs(v.Group,{controlId:"link",children:[e.jsx(v.Label,{children:"Link"}),S.values.hasSubGroups?e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:"Can't have link (has sub groups)",disabled:!0}):e.jsxs(e.Fragment,{children:[e.jsx(v.Control,{as:"input",placeholder:"/groups/...",name:"link",onChange:S.handleChange,className:"text-primary w-100",value:S.values.link??"",disabled:u}),e.jsx(v.Text,{className:"text-danger",children:S.touched.link&&S.errors.link?e.jsx("div",{className:"text-danger",children:S.errors.link}):null})]})]}),e.jsxs(v.Group,{children:[e.jsxs(v.Label,{className:"m-1 mb-0",children:["Answers (",`${S.values.numOfAnswers}`,") "]}),P&&e.jsx(Ze,{groupRow:l})]}),(u||w)&&e.jsx($e,{created:l.created,modified:l.modified,classes:"text-primary"}),(S.dirty&&w||y)&&e.jsx(We,{cancelForm:_,handleSubmit:S.handleSubmit,title:t})]})]})},Ye=({inLine:s})=>{const l=ee(),{nickName:d}=l.authUser,{state:t,updateGroup:o}=K(),{activeGroup:u,keyExpanded:w}=t,{answerId:y}=w,G=async a=>{const R={...a,created:void 0,modified:{time:new Date,nickName:d}};await o(R,!0)};return e.jsx(Ie,{inLine:s,group:{...u},answerId:y,formMode:E.EditingGroup,submitForm:G,children:"Update Group"})},es=({inLine:s})=>{const{state:l}=K(),{activeGroup:d,keyExpanded:t}=l,{answerId:o}=t;return e.jsx(Ie,{inLine:s,group:{...d},answerId:o,formMode:E.ViewingGroup,submitForm:()=>{},children:"View Group"})},ss=({activeGroup:s})=>{const l=ee(),{nickName:d}=l.authUser,{createGroup:t}=K(),[o]=f.useState({...s}),u=async w=>{const y={...w,created:{time:new Date,nickName:d},modified:void 0};console.log("**********object",y),await t(y)};return!s===null?null:(console.log("AddGroup render >>>>>:",s),e.jsx(e.Fragment,{children:e.jsx(Ie,{inLine:!1,group:o,answerId:null,formMode:E.AddingGroup,submitForm:u,children:"Create Group"})}))},Ws=({groupRow:s,answerId:l})=>{const{id:d,title:t,hasSubGroups:o,numOfAnswers:u,isExpanded:w}=s;s.level+=1;const y=new re(s).groupKey,{canEdit:G,authUser:a}=ee(),{state:R,addSubGroup:A,viewGroup:j,editGroup:N,deleteGroup:P,expandGroup:I,collapseGroup:B,addAnswer:_}=K();let{formMode:O,activeGroup:F,loadingGroup:W,groupLoaded:S}=R;const b=F!==null&&F.id===d,C=O===E.AddingGroup,V=w&&u>0,x=()=>{s.modified={time:new Date,nickName:a.nickName},P(s)},k=async()=>{if(w)await B(s);else{const le={groupKey:y,byClick:!0,formMode:G?E.EditingGroup:E.ViewingGroup};await I(le)}},se=async()=>{G?await N(s,l??"null"):await j(s,l??"null")},[U,M]=f.useState(!1);f.useEffect(()=>{U&&(A(s),M(!1))},[A,s,U]);const[Y,L]=f.useState(!1);f.useEffect(()=>{Y&&(_(y,w??!1),L(!1))},[_,y,w,Y]),f.useEffect(()=>{(async()=>{if(b&&!W&&!S&&!C)switch(console.log("GroupRow formMode:",O),O){case E.ViewingGroup:await j(s,l??"null");break;case E.EditingGroup:G?await N(s,l??"null"):await j(s,l??"null");break}})()},[G,y,S,s,N,I,O,C,b,W,l,j]);const[H,ne]=Te(),q=e.jsxs("div",{children:[e.jsxs("div",{id:`Row${d}`,className:`d-relative d-flex justify-content-start align-items-center w-100 group-row${b?"-selected":""}`,style:{marginTop:"1px"},children:[e.jsx(z,{variant:"link",size:"sm",className:"py-0 px-1",onClick:le=>{k(),le.stopPropagation()},title:"Expand",disabled:C||!o&&u===0,children:e.jsx(te,{icon:w?Le:Ue,size:"lg"})}),e.jsx(z,{variant:"link",size:"sm",className:"py-0 px-1 bg-light",title:"Expand",disabled:!0,children:e.jsx(te,{icon:Os,size:"sm"})}),e.jsx(z,{variant:"link",size:"sm",className:`py-0 ms-0 me-1 group-row-title ${b?"fw-bold text-white bg-transparent":""}`,title:d,onClick:se,disabled:C,children:t}),u>0&&e.jsxs(Ve,{pill:!0,bg:"secondary",className:"d-inline bg-transparent",children:[u,"Q"]}),G&&ne&&e.jsxs("div",{className:"position-absolute text-nowrap d-flex align-items-center border border-0 border-warning p-0 end-0",children:[e.jsx("div",{className:"d-flex align-items-center",children:e.jsx(z,{variant:"link",size:"sm",className:"border-0 py-0 px-0 ms-0 text-success",title:"Add SubGroup",onClick:async()=>{!w&&(o||u>0)&&await k(),setTimeout(()=>M(!0),500)},children:e.jsx(te,{icon:js,size:"lg"})})}),!C&&!o&&e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(z,{variant:"link",size:"sm",className:"p-0 mx-0 text-secondary position-relative float-end d-flex align-items-center",title:"Add Answer",onClick:async()=>{!w&&(o||u>0)&&await k(),setTimeout(()=>L(!0),500)},children:e.jsx("img",{width:"22",height:"18",src:Ps,alt:"Add Answer"})}),e.jsx(z,{variant:"link",size:"sm",className:"p-0 ms-0 position-relative float-end d-flex align-items-center",disabled:o||u>0,onClick:x,children:e.jsx(te,{icon:Ne,size:"lg"})})]})]})]}),V&&e.jsx("div",{className:"ps-3",children:e.jsx(Ze,{groupRow:s})})]});return e.jsxs(e.Fragment,{children:[e.jsxs(ae.Item,{className:"py-0 px-1 w-100 group-bg",as:"li",children:[b&&O===E.AddingGroup&&e.jsxs("div",{children:[e.jsx("div",{ref:H,className:"",children:q}),e.jsx("div",{className:"ms-0 d-md-none w-100",children:e.jsx(ss,{activeGroup:F})})]}),b&&O===E.EditingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:H,className:"",children:q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(Ye,{inLine:!1})})]}),b&&O===E.ViewingGroup&&e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:H,className:"",children:q}),e.jsx("div",{id:"divInLine",className:"ms-0 d-md-none w-100",children:e.jsx(es,{inLine:!1})})]}),!b&&e.jsx("div",{ref:H,className:"",children:q})]}),R.error&&R.whichRowId===d&&e.jsx("div",{className:"text-danger",children:R.error.message}),w&&e.jsx(ae.Item,{className:"py-0 px-0 border-0 border-warning border-bottom-0 group-bg",variant:"primary",as:"li",children:w&&e.jsx(e.Fragment,{children:o&&e.jsx(ns,{groupRow:s,title:t,isExpanded:w})})})]})},ns=({groupRow:s,title:l})=>{const{state:d}=K();let{keyExpanded:t}=d;const{answerId:o}=t??{answerId:null};let u=1,w=[];return l==="ROOT"?w=d.topRows:(w=s.groupRows,u=s.level),e.jsx("div",{className:u>1?"ms-2":"",children:e.jsx(ae,{as:"ul",variant:"dark",className:"mb-0 group-bg",children:w.map(y=>e.jsx(Ws,{groupRow:y,answerId:o},y.id))})})},Vs=s=>{const{isDarkMode:l}=ee(),[d,t]=f.useState("");return f.useEffect(()=>{},[]),e.jsxs(xe,{show:s.show,onHide:s.onHide,animation:!0,centered:!0,size:"lg",className:"modal show",contentClassName:`${l?"bg-secondary bg-gradient":"bg-info bg-gradient"}`,children:[e.jsx(xe.Header,{closeButton:!0,children:"Store new Answer to the Database"}),e.jsx(xe.Body,{className:"py-0",children:e.jsx(je,{closeModal:s.onHide,showCloseButton:!1,source:1,setError:o=>t(o)})}),e.jsx(xe.Footer,{children:d})]})},Ks=({groupId_answerId:s,fromChatBotDlg:l})=>{const{state:d,expandNodesUpToTheTree:t,loadTopRows:o,addSubGroup:u}=K(),{allGroupRows:w,topRows:y,topRowsLoading:G,topRowsLoaded:a,keyExpanded:R,groupId_answerId_done:A,nodeOpening:j,nodeOpened:N,activeGroup:P,activeAnswer:I,formMode:B,loadingGroups:_,loadingGroup:O,loadingAnswers:F,loadingAnswer:W}=d,{searchAnswers:S,setLastRouteVisited:b}=hs(),{isDarkMode:C}=ee(),[V,x]=f.useState(!1),[k,se]=f.useState({..._e}),U=ve(),M=async L=>{U({type:n.SET_ANSWER_SELECTED,payload:{answerKey:L}})};let Y="";return f.useEffect(()=>{(async()=>!G&&!a&&(console.log("ZOVEM 111 loadTopRows()"),await o()))()},[G,a,o]),f.useEffect(()=>{(async()=>{if(!j&&y.length>0){if(s){if(s==="add_answer"){const L=localStorage.getItem("New_Answer");if(L){const H=JSON.parse(L);return se({..._e,groupTitle:"Select",...H}),x(!0),localStorage.removeItem("New_Answer"),null}}else if(s!==A){const L=s.split("_"),H=L[0],ne=L[1],q={topId:"",id:H,parentId:"ROOT"};console.log("zovem expandNodesUpToTheTree 1111111111111111111)",{groupId_answerId:s},{groupId_answerId_done:A}),await t(q,ne,l??"false").then(()=>null)}}else if(R&&!N){const{topId:L,groupId:H,answerId:ne}=R;if(H!==""){const q={topId:L,id:H,parentId:"ROOT"};console.log("zovem expandNodeUpToTheTree 2222222222222)",{keyExpanded:R,grpKey:q}),await t(q,ne).then(()=>null)}}}})()},[R,j,N,t,s,A,y,l]),f.useEffect(()=>{b("/groups")},[b]),s!=="add_answer"&&s&&s!==A?(console.log("zzzzzz loading...",{keyExpanded:R,groupId_answerId:s,groupId_answerId_done:A}),e.jsx("div",{children:"loading..."})):!a||y.length===0?(console.log("===>>> Groups  VRATIO"),null):(console.log("===>>> Groups !!!!!!!!!!!!!!!!!",P),e.jsxs(e.Fragment,{children:[e.jsxs(As,{children:[e.jsxs("h5",{className:"text-warning mx-auto w-75 fw-bold",children:[e.jsx("span",{className:"groups",children:"Groups / "}),e.jsx("span",{className:"answers",children:"Answers"})]}),e.jsx(ce,{className:`${C?"dark":""}`,children:e.jsx(ie,{children:e.jsx("div",{className:"d-flex justify-content-start align-items-center",children:e.jsx("div",{className:"w-75 my-1 answers",children:e.jsx(Is,{tekst:Y,onSelectAnswer:M,allGroupRows:w,searchAnswers:S})})})})}),e.jsx(z,{variant:"secondary",size:"sm",type:"button",style:{padding:"1px 4px"},onClick:()=>u(null),children:"Add Group"}),e.jsxs(ce,{className:"my-1 h-auto",children:[e.jsx(ie,{xs:12,md:5,children:e.jsx("div",{className:"groups-border",style:{position:"relative"},children:e.jsx(ns,{groupRow:null,title:"ROOT",isExpanded:!0})})}),e.jsx(ie,{xs:0,md:7,children:e.jsxs("div",{id:"div-details",className:"d-none d-md-block",children:[P&&B===E.ViewingGroup&&e.jsx(es,{inLine:!1}),P&&B===E.EditingGroup&&e.jsx(Ye,{inLine:!1}),P&&B===E.AddingGroup&&e.jsx(ss,{activeGroup:P}),I&&B===E.ViewingAnswer&&e.jsx(Je,{inLine:!1}),I&&B===E.EditingAnswer&&e.jsx(Qe,{inLine:!1}),I&&B===E.AddingAnswer&&e.jsx(je,{})]})})]})]}),V&&I&&e.jsx(Vs,{show:V,onHide:()=>{x(!1)},newAnswerRow:k}),(_||F)&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"40%",left:"20%"},children:e.jsx("div",{className:`spinner-border ${F?"answer":"group"}-spinner`,role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),O&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border group-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),W&&e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{position:"absolute",top:"50%",left:"50%"},children:e.jsx("div",{className:"spinner-border answer-spinner",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})]}))},Qs=()=>{let{groupId_answerId:s,fromChatBotDlg:l}=Rs();if(s&&s==="groups"&&(s=void 0),s){const d=s.split("_");console.assert(d.length===2,"expected 'groupId_answerId'")}return e.jsx(ks,{children:e.jsx(Ks,{groupId_answerId:s,fromChatBotDlg:l})})};export{Qs as default};
//# sourceMappingURL=Groups-khdFYxPQ.js.map
